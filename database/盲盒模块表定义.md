# 盲盒模块表定义

## 概述
盲盒模块包含盲盒模板管理、盲盒实例生成、用户盲盒抽奖、赠送记录管理以及相关的统计缓存。支持商品SKU和积分奖励两种奖品类型，通过模板控制盲盒规则和概率。

## 表结构定义

### 1. 盲盒组模板表 (t_box_blind_box_template)

#### 表结构
```sql
CREATE TABLE t_box_blind_box_template (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    template_name VARCHAR(200) NOT NULL COMMENT '模板名称',
    template_code VARCHAR(50) UNIQUE NOT NULL COMMENT '模板编码',
    template_type VARCHAR(20) NOT NULL COMMENT '模板类型：FIXED-固定奖品，RANDOM-随机奖品，TIERED-分层奖品',
    box_count INT NOT NULL COMMENT '盲盒数量',
    price DECIMAL(10,2) NOT NULL COMMENT '盲盒价格',
    total_probability DECIMAL(5,4) NOT NULL DEFAULT 1.0000 COMMENT '总概率（必须为1）',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-启用，0-禁用',
    start_time DATETIME COMMENT '销售开始时间',
    end_time DATETIME COMMENT '销售结束时间',
    description TEXT COMMENT '模板描述',
    image_url VARCHAR(500) COMMENT '模板图片URL',
    sort_order INT DEFAULT 0 COMMENT '排序序号',
    max_purchase_per_user INT COMMENT '每人最多购买数量',
    daily_purchase_limit INT COMMENT '每日购买限制',
    total_stock INT NOT NULL COMMENT '总库存',
    remaining_stock INT NOT NULL COMMENT '剩余库存',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_template_code (template_code),
    INDEX idx_template_type (template_type),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time),
    INDEX idx_sort_order (sort_order),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒组模板表';
```

#### 业务节点说明

**创建节点**：
- 管理员创建新的盲盒模板
- 系统根据活动需求创建限时模板
- 运营人员设计盲盒规则时创建模板

**变更节点**：
- 模板信息更新时修改基本信息
- 价格调整时更新price字段
- 库存变化时更新库存相关字段
- 销售时间调整时更新时间字段
- 状态变更时更新status

**删除节点**：
- 模板不再使用时逻辑删除
- 活动结束且模板过期时删除
- 模板配置错误需要清理时删除

---

### 2. 盲盒组模板物品表 (t_box_template_item)

#### 表结构
```sql
CREATE TABLE t_box_template_item (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    template_id BIGINT NOT NULL COMMENT '模板ID',
    item_type VARCHAR(20) NOT NULL COMMENT '物品类型：SKU-商品SKU，POINTS-积分奖励',
    sku_id BIGINT COMMENT 'SKU ID（当item_type为SKU时使用）',
    product_name VARCHAR(200) COMMENT '商品名称',
    points_amount BIGINT COMMENT '积分数量（当item_type为POINTS时使用）',
    probability DECIMAL(5,4) NOT NULL COMMENT '中奖概率',
    item_count INT NOT NULL DEFAULT 1 COMMENT '物品数量',
    remaining_count INT NOT NULL DEFAULT 1 COMMENT '剩余数量',
    tier_level INT COMMENT '奖品等级：1-一等奖，2-二等奖，3-三等奖',
    item_image VARCHAR(500) COMMENT '物品图片URL',
    item_description VARCHAR(500) COMMENT '物品描述',
    sort_order INT DEFAULT 0 COMMENT '排序序号',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-禁用',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_template_id (template_id),
    INDEX idx_item_type (item_type),
    INDEX idx_sku_id (sku_id),
    INDEX idx_tier_level (tier_level),
    INDEX idx_probability (probability),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒组模板物品表';
```

#### 业务节点说明

**创建节点**：
- 模板创建时同步创建奖品配置
- 为现有模板添加新的奖品时创建
- 奖品配置调整时创建新的物品记录

**变更节点**：
- 奖品概率调整时更新probability
- 奖品数量变化时更新count字段
- 奖品信息更新时修改描述等字段
- 状态变更时更新status

**删除节点**：
- 奖品不再发放时逻辑删除
- 模板删除时清理相关奖品
- 奖品配置错误时删除

---

### 3. 盲盒组实例表 (t_box_group_instance)

#### 表结构
```sql
CREATE TABLE t_box_group_instance (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    instance_no VARCHAR(50) UNIQUE NOT NULL COMMENT '实例编号',
    template_id BIGINT NOT NULL COMMENT '模板ID',
    group_name VARCHAR(200) COMMENT '盲盒组名称',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    expiry_time DATETIME COMMENT '过期时间',
    total_boxes INT NOT NULL COMMENT '总盲盒数量',
    sold_boxes INT DEFAULT 0 COMMENT '已售出数量',
    remaining_boxes INT NOT NULL COMMENT '剩余盲盒数量',
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE-激活，INACTIVE-未激活，EXPIRED-过期，SOLD_OUT-售罄',
    sales_start_time DATETIME COMMENT '销售开始时间',
    sales_end_time DATETIME COMMENT '销售结束时间',

    -- 统计信息
    total_sales_amount DECIMAL(10,2) DEFAULT 0 COMMENT '总销售额',
    total_draw_count INT DEFAULT 0 COMMENT '总抽奖次数',
    total_win_count INT DEFAULT 0 COMMENT '总中奖次数',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_instance_no (instance_no),
    INDEX idx_template_id (template_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time),
    INDEX idx_expiry_time (expiry_time),
    INDEX idx_sales_start_time (sales_start_time),
    INDEX idx_sales_end_time (sales_end_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒组实例表';
```

#### 业务节点说明

**创建节点**：
- 根据模板生成盲盒组实例
- 活动开始时批量创建实例
- 用户购买盲盒时动态生成实例

**变更节点**：
- 销售数据更新时修改统计字段
- 状态变化时更新status
- 过期时间调整时更新expiry_time
- 剩余数量变化时更新remaining_boxes

**删除节点**：
- 实例过期且已售罄时逻辑删除
- 活动结束时清理相关实例
- 系统定期清理过期实例

---

### 4. 用户盲盒赠送记录表 (t_box_user_gift_record)

#### 表结构
```sql
CREATE TABLE t_box_user_gift_record (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    gift_no VARCHAR(50) UNIQUE NOT NULL COMMENT '赠送编号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    gift_type VARCHAR(20) NOT NULL COMMENT '赠送类型：PURCHASE-购买，REWARD-奖励，GIFT-赠送',
    box_count INT NOT NULL COMMENT '盲盒数量',
    total_amount DECIMAL(10,2) COMMENT '总金额',
    gift_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '赠送时间',
    expiry_time DATETIME COMMENT '过期时间',
    used_count INT DEFAULT 0 COMMENT '已使用数量',
    remaining_count INT NOT NULL COMMENT '剩余数量',
    status VARCHAR(20) NOT NULL DEFAULT 'VALID' COMMENT '状态：VALID-有效，USED-已使用，EXPIRED-过期，CANCELLED-取消',

    -- 赠送来源信息
    source_type VARCHAR(20) COMMENT '来源类型：ORDER-订单，ACTIVITY-活动，ADMIN-管理员',
    source_id BIGINT COMMENT '来源ID',
    gift_reason VARCHAR(200) COMMENT '赠送原因',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_gift_no (gift_no),
    INDEX idx_user_id (user_id),
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_gift_type (gift_type),
    INDEX idx_status (status),
    INDEX idx_gift_time (gift_time),
    INDEX idx_expiry_time (expiry_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户盲盒赠送记录表';
```

#### 业务节点说明

**创建节点**：
- 用户购买盲盒时创建赠送记录
- 系统奖励用户时创建记录
- 管理员赠送盲盒时创建记录

**变更节点**：
- 用户使用盲盒时更新使用数量
- 状态变化时更新status
- 过期时间调整时更新expiry_time

**删除节点**：
- 赠送记录过期且已使用完时逻辑删除
- 用户注销账户时清理相关记录
- 系统定期清理过期记录

---

### 5. 盲盒实例表 (t_box_blind_box_instance)

#### 表结构
```sql
CREATE TABLE t_box_blind_box_instance (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    instance_no VARCHAR(50) UNIQUE NOT NULL COMMENT '盲盒实例编号',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    gift_record_id BIGINT NOT NULL COMMENT '赠送记录ID',
    template_item_id BIGINT COMMENT '模板物品ID',
    box_index INT NOT NULL COMMENT '盲盒序号',
    status VARCHAR(20) NOT NULL DEFAULT 'AVAILABLE' COMMENT '状态：AVAILABLE-可抽奖，DRAWN-已抽奖，EXPIRED-过期',
    draw_time DATETIME COMMENT '抽奖时间',
    draw_result VARCHAR(20) COMMENT '抽奖结果：WIN-中奖，LOSE-未中奖',
    item_type VARCHAR(20) COMMENT '奖品类型：SKU-商品SKU，POINTS-积分',
    sku_id BIGINT COMMENT 'SKU ID',
    points_amount BIGINT COMMENT '积分数量',
    item_name VARCHAR(200) COMMENT '奖品名称',
    item_image VARCHAR(500) COMMENT '奖品图片URL',
    item_description VARCHAR(500) COMMENT '奖品描述',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_instance_no (instance_no),
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_gift_record_id (gift_record_id),
    INDEX idx_template_item_id (template_item_id),
    INDEX idx_status (status),
    INDEX idx_draw_time (draw_time),
    INDEX idx_draw_result (draw_result),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒实例表';
```

#### 业务节点说明

**创建节点**：
- 盲盒组实例创建时批量生成盲盒实例
- 用户获得盲盒时为每个盲盒创建实例记录

**变更节点**：
- 用户抽奖时更新抽奖结果和状态
- 盲盒过期时更新status
- 奖品信息补充时更新相关字段

**删除节点**：
- 盲盒已抽奖且过期时逻辑删除
- 赠送记录删除时清理相关实例
- 系统定期清理过期实例

---

### 6. 盲盒抽奖记录表 (t_box_draw_record)

#### 表结构
```sql
CREATE TABLE t_box_draw_record (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    draw_no VARCHAR(50) UNIQUE NOT NULL COMMENT '抽奖编号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    box_instance_id BIGINT NOT NULL COMMENT '盲盒实例ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    gift_record_id BIGINT NOT NULL COMMENT '赠送记录ID',
    draw_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '抽奖时间',
    draw_result VARCHAR(20) NOT NULL COMMENT '抽奖结果：WIN-中奖，LOSE-未中奖',
    item_type VARCHAR(20) COMMENT '奖品类型：SKU-商品SKU，POINTS-积分',
    sku_id BIGINT COMMENT 'SKU ID',
    points_amount BIGINT COMMENT '积分数量',
    item_name VARCHAR(200) COMMENT '奖品名称',
    item_description VARCHAR(500) COMMENT '奖品描述',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',
    draw_cost DECIMAL(10,2) COMMENT '抽奖消耗（积分或金额）',
    delivery_status VARCHAR(20) COMMENT '发货状态：PENDING-待发货，SHIPPED-已发货，DELIVERED-已送达，RECEIVED-已签收',
    delivery_info TEXT COMMENT '发货信息（JSON格式）',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    UNIQUE KEY uk_draw_no (draw_no),
    INDEX idx_user_id (user_id),
    INDEX idx_box_instance_id (box_instance_id),
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_gift_record_id (gift_record_id),
    INDEX idx_draw_result (draw_result),
    INDEX idx_draw_time (draw_time),
    INDEX idx_delivery_status (delivery_status),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒抽奖记录表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户抽奖时记录抽奖过程和结果
- 系统自动抽奖时记录日志

**变更节点**：
- 发货状态更新时修改delivery_status
- 补充发货信息时更新delivery_info

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 用户注销账户时清理相关日志

---

### 7. 盲盒实例模板关联表 (t_box_instance_template_rel)

#### 表结构
```sql
CREATE TABLE t_box_instance_template_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    box_instance_id BIGINT NOT NULL COMMENT '盲盒实例ID',
    template_item_id BIGINT NOT NULL COMMENT '模板物品ID',
    probability DECIMAL(5,4) NOT NULL COMMENT '实际概率',
    is_winner TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否中奖：0-否，1-是',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_box_template (box_instance_id, template_item_id),
    INDEX idx_box_instance_id (box_instance_id),
    INDEX idx_template_item_id (template_item_id),
    INDEX idx_is_winner (is_winner),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒实例模板关联表';
```

#### 业务节点说明

**创建节点**：
- 盲盒实例创建时建立与模板物品的关联
- 系统生成盲盒时自动创建关联

**变更节点**：
- 抽奖时更新is_winner状态
- 概率调整时更新probability

**删除节点**：
- 盲盒实例删除时清理关联
- 模板物品删除时清理相关关联

---

### 8. 盲盒实例赠送关联表 (t_box_instance_gift_rel)

#### 表结构
```sql
CREATE TABLE t_box_instance_gift_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    box_instance_id BIGINT NOT NULL COMMENT '盲盒实例ID',
    gift_record_id BIGINT NOT NULL COMMENT '赠送记录ID',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_box_gift (box_instance_id, gift_record_id),
    INDEX idx_box_instance_id (box_instance_id),
    INDEX idx_gift_record_id (gift_record_id),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒实例赠送关联表';
```

#### 业务节点说明

**创建节点**：
- 盲盒实例分配给用户时创建关联
- 赠送记录生成时自动建立关联

**变更节点**：
- 通常关联关系不进行变更，以保证关联的稳定

**删除节点**：
- 盲盒实例删除时清理关联
- 赠送记录删除时清理相关关联

---

### 9. 盲盒组统计缓存表 (t_box_group_stats_cache)

#### 表结构
```sql
CREATE TABLE t_box_group_stats_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    total_draw_count BIGINT DEFAULT 0 COMMENT '总抽奖次数',
    total_win_count BIGINT DEFAULT 0 COMMENT '总中奖次数',
    total_sales_amount DECIMAL(10,2) DEFAULT 0 COMMENT '总销售额',
    total_user_count BIGINT DEFAULT 0 COMMENT '参与用户数',
    daily_draw_count BIGINT DEFAULT 0 COMMENT '今日抽奖次数',
    daily_win_count BIGINT DEFAULT 0 COMMENT '今日中奖次数',
    daily_sales_amount DECIMAL(10,2) DEFAULT 0 COMMENT '今日销售额',
    stats_date DATE COMMENT '统计日期',
    last_update_time DATETIME NOT NULL COMMENT '最后更新时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_group_instance_id (group_instance_id),
    INDEX idx_stats_date (stats_date),
    INDEX idx_last_update_time (last_update_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒组统计缓存表';
```

#### 业务节点说明

**创建节点**：
- 盲盒组实例创建时初始化统计缓存
- 系统定期生成统计数据时创建

**变更节点**：
- 抽奖数据更新时修改统计字段
- 每日定时任务更新日统计数据
- 销售数据变化时更新销售额统计

**删除节点**：
- 盲盒组实例删除时清理统计缓存
- 系统定期清理过期统计数据

---

### 10. 用户盲盒统计缓存表 (t_box_user_stats_cache)

#### 表结构
```sql
CREATE TABLE t_box_user_stats_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    total_draw_count BIGINT DEFAULT 0 COMMENT '总抽奖次数',
    total_win_count BIGINT DEFAULT 0 COMMENT '总中奖次数',
    total_consume_amount DECIMAL(10,2) DEFAULT 0 COMMENT '总消费金额',
    total_win_amount DECIMAL(10,2) DEFAULT 0 COMMENT '总中奖金额',
    daily_draw_count BIGINT DEFAULT 0 COMMENT '今日抽奖次数',
    daily_win_count BIGINT DEFAULT 0 COMMENT '今日中奖次数',
    weekly_draw_count BIGINT DEFAULT 0 COMMENT '本周抽奖次数',
    weekly_win_count BIGINT DEFAULT 0 COMMENT '本周中奖次数',
    monthly_draw_count BIGINT DEFAULT 0 COMMENT '本月抽奖次数',
    monthly_win_count BIGINT DEFAULT 0 COMMENT '本月中奖次数',
    last_draw_time DATETIME COMMENT '最后抽奖时间',
    stats_date DATE COMMENT '统计日期',
    last_update_time DATETIME NOT NULL COMMENT '最后更新时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_last_draw_time (last_draw_time),
    INDEX idx_stats_date (stats_date),
    INDEX idx_last_update_time (last_update_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户盲盒统计缓存表';
```

#### 业务节点说明

**创建节点**：
- 用户首次抽奖时创建统计缓存
- 系统定期生成用户统计时创建

**变更节点**：
- 用户抽奖时更新抽奖统计
- 每日定时任务更新日统计数据
- 中奖时更新中奖统计数据

**删除节点**：
- 用户注销账户时清理统计缓存
- 系统定期清理长期未活跃用户的统计

---

### 11. 盲盒组创建日志表 (t_box_group_create_log)

#### 表结构
```sql
CREATE TABLE t_box_group_create_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    template_id BIGINT NOT NULL COMMENT '模板ID',
    create_type VARCHAR(20) NOT NULL COMMENT '创建类型：AUTO-自动创建，MANUAL-手动创建，BATCH-批量创建',
    box_count INT NOT NULL COMMENT '创建盲盒数量',
    total_probability DECIMAL(5,4) COMMENT '总概率',
    create_reason VARCHAR(200) COMMENT '创建原因',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_template_id (template_id),
    INDEX idx_create_type (create_type),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_group_time (group_instance_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒组创建日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 盲盒组实例创建时记录创建日志
- 系统自动创建盲盒组时记录
- 管理员手动创建时记录

**变更节点**：
- 通常创建日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留6个月）
- 系统存储空间不足时清理最旧的日志

---

### 12. 盲盒赠送日志表 (t_box_gift_log)

#### 表结构
```sql
CREATE TABLE t_box_gift_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    gift_record_id BIGINT NOT NULL COMMENT '赠送记录ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    gift_type VARCHAR(20) NOT NULL COMMENT '赠送类型',
    box_count INT NOT NULL COMMENT '赠送盲盒数量',
    total_amount DECIMAL(10,2) COMMENT '赠送金额',
    gift_reason VARCHAR(200) COMMENT '赠送原因',
    source_type VARCHAR(20) COMMENT '来源类型',
    source_id BIGINT COMMENT '来源ID',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_gift_record_id (gift_record_id),
    INDEX idx_user_id (user_id),
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_gift_type (gift_type),
    INDEX idx_source_type (source_type),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒赠送日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户获得盲盒时记录赠送日志
- 系统赠送盲盒时记录
- 管理员赠送盲盒时记录

**变更节点**：
- 通常赠送日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留6个月）
- 用户注销账户时清理相关日志

---

### 13. 盲盒抽奖日志表 (t_box_draw_log)

#### 表结构
```sql
CREATE TABLE t_box_draw_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    draw_record_id BIGINT NOT NULL COMMENT '抽奖记录ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    box_instance_id BIGINT NOT NULL COMMENT '盲盒实例ID',
    group_instance_id BIGINT NOT NULL COMMENT '盲盒组实例ID',
    gift_record_id BIGINT NOT NULL COMMENT '赠送记录ID',
    draw_result VARCHAR(20) NOT NULL COMMENT '抽奖结果',
    item_type VARCHAR(20) COMMENT '奖品类型',
    item_name VARCHAR(200) COMMENT '奖品名称',
    draw_cost DECIMAL(10,2) COMMENT '抽奖消耗',
    probability DECIMAL(5,4) COMMENT '中奖概率',
    random_value DECIMAL(5,4) COMMENT '随机值',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',
    draw_source VARCHAR(20) COMMENT '抽奖来源：USER-用户抽奖，SYSTEM-系统抽奖',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_draw_record_id (draw_record_id),
    INDEX idx_user_id (user_id),
    INDEX idx_box_instance_id (box_instance_id),
    INDEX idx_group_instance_id (group_instance_id),
    INDEX idx_gift_record_id (gift_record_id),
    INDEX idx_draw_result (draw_result),
    INDEX idx_draw_source (draw_source),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒抽奖日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户抽奖时记录抽奖过程日志
- 系统自动抽奖时记录日志

**变更节点**：
- 通常抽奖日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留6个月）
- 用户注销账户时清理相关日志

---

### 14. 盲盒领取日志表 (t_box_receive_log)

#### 表结构
```sql
CREATE TABLE t_box_receive_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    draw_record_id BIGINT NOT NULL COMMENT '抽奖记录ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    box_instance_id BIGINT NOT NULL COMMENT '盲盒实例ID',
    receive_type VARCHAR(20) NOT NULL COMMENT '领取类型：AUTO-自动领取，MANUAL-手动领取',
    item_type VARCHAR(20) NOT NULL COMMENT '奖品类型',
    item_name VARCHAR(200) COMMENT '奖品名称',
    receive_status VARCHAR(20) NOT NULL DEFAULT 'SUCCESS' COMMENT '领取状态：SUCCESS-成功，FAILED-失败',
    failure_reason VARCHAR(200) COMMENT '失败原因',
    delivery_info TEXT COMMENT '发货信息（JSON格式）',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_draw_record_id (draw_record_id),
    INDEX idx_user_id (user_id),
    INDEX idx_box_instance_id (box_instance_id),
    INDEX idx_receive_type (receive_type),
    INDEX idx_receive_status (receive_status),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='盲盒领取日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户领取奖品时记录领取日志
- 系统自动发放奖品时记录
- 奖品发放失败时记录失败日志

**变更节点**：
- 领取信息补充时更新相关字段

**删除节点**：
- 按时间定期清理过期日志（通常保留6个月）
- 用户注销账户时清理相关日志

---

## 数据管理策略

### 数据清理策略
1. **模板数据**：永久保留，除非模板明确废弃
2. **实例数据**：保留1年，超过1年的过期实例清理
3. **赠送记录**：永久保留，用于用户消费记录
4. **抽奖记录**：永久保留，用于中奖记录
5. **统计缓存**：随实例生命周期清理
6. **日志数据**：保留6个月，超过6个月的数据清理

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：盲盒信息和概率数据使用Redis缓存

### 安全策略
1. **抽奖操作审计**：所有抽奖操作必须记录详细日志
2. **概率控制**：通过模板确保奖品概率的准确性
3. **防刷机制**：抽奖需要防刷机制控制频率
4. **数据一致性**：通过事务保证库存和中奖数据的一致性
