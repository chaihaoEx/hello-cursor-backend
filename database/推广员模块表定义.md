# 推广员模块表定义

## 概述
推广员模块包含推广员基本信息管理、佣金规则配置、佣金提现处理、推广关系管理以及相关统计功能。支持多级推广体系，通过关联表维护用户与推广员的关系。

## 表结构定义

### 1. 推广员表 (t_promoter_promoter)

#### 表结构
```sql
CREATE TABLE t_promoter_promoter (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    promoter_no VARCHAR(50) UNIQUE NOT NULL COMMENT '推广员编号',
    user_id BIGINT NOT NULL COMMENT '关联用户ID',
    promoter_name VARCHAR(100) COMMENT '推广员姓名',
    promoter_level VARCHAR(20) NOT NULL DEFAULT 'NORMAL' COMMENT '推广员等级：NORMAL-普通推广员，VIP-VIP推广员，PARTNER-合作伙伴',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-冻结，2-注销',
    total_commission DECIMAL(10,2) DEFAULT 0 COMMENT '累计佣金',
    available_commission DECIMAL(10,2) DEFAULT 0 COMMENT '可用佣金',
    frozen_commission DECIMAL(10,2) DEFAULT 0 COMMENT '冻结佣金',
    withdrawn_commission DECIMAL(10,2) DEFAULT 0 COMMENT '已提现佣金',
    direct_downline_count INT DEFAULT 0 COMMENT '直推下线数量',
    total_downline_count INT DEFAULT 0 COMMENT '总下线数量',
    apply_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    approve_time DATETIME COMMENT '审核通过时间',
    approve_user_id BIGINT COMMENT '审核人ID',
    approve_remark VARCHAR(500) COMMENT '审核备注',

    -- 推广统计
    today_commission DECIMAL(10,2) DEFAULT 0 COMMENT '今日佣金',
    week_commission DECIMAL(10,2) DEFAULT 0 COMMENT '本周佣金',
    month_commission DECIMAL(10,2) DEFAULT 0 COMMENT '本月佣金',
    last_commission_time DATETIME COMMENT '最后获得佣金时间',

    -- 联系信息
    contact_phone VARCHAR(20) COMMENT '联系电话',
    contact_wechat VARCHAR(50) COMMENT '微信号',
    contact_email VARCHAR(100) COMMENT '邮箱',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_promoter_no (promoter_no),
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_promoter_level (promoter_level),
    INDEX idx_apply_time (apply_time),
    INDEX idx_approve_time (approve_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推广员表';
```

#### 业务节点说明

**创建节点**：
- 用户申请成为推广员时创建记录
- 管理员后台添加推广员时创建
- 系统自动邀请用户成为推广员时创建

**变更节点**：
- 推广员等级升级时更新level字段
- 佣金发生变化时更新佣金相关字段
- 推广员状态变更时更新status
- 下线数量变化时更新统计字段
- 推广员信息更新时修改联系方式等

**删除节点**：
- 推广员主动注销时逻辑删除
- 违规推广员被管理员禁用时逻辑删除
- 系统定期清理无效推广员记录

---

### 2. 佣金规则表 (t_promoter_commission_rule)

#### 表结构
```sql
CREATE TABLE t_promoter_commission_rule (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    rule_name VARCHAR(100) NOT NULL COMMENT '规则名称',
    rule_code VARCHAR(50) UNIQUE NOT NULL COMMENT '规则编码',
    rule_type VARCHAR(20) NOT NULL COMMENT '规则类型：DIRECT-直推佣金，INDIRECT-间接佣金，PERFORMANCE-绩效佣金',
    commission_level INT NOT NULL DEFAULT 1 COMMENT '佣金等级：1-一级，2-二级，3-三级',
    commission_rate DECIMAL(5,4) NOT NULL COMMENT '佣金比例（0.01表示1%）',
    commission_amount DECIMAL(10,2) COMMENT '固定佣金金额（可选）',
    min_order_amount DECIMAL(10,2) DEFAULT 0 COMMENT '最低订单金额',
    max_commission_amount DECIMAL(10,2) COMMENT '最高佣金金额限制',
    settlement_cycle VARCHAR(20) NOT NULL DEFAULT 'ORDER_COMPLETE' COMMENT '结算周期：ORDER_COMPLETE-订单完成，MONTHLY-月结，WEEKLY-周结',
    settlement_delay_days INT DEFAULT 0 COMMENT '结算延迟天数',
    effective_start_time DATETIME COMMENT '生效开始时间',
    effective_end_time DATETIME COMMENT '生效结束时间',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-启用，0-禁用',
    rule_description TEXT COMMENT '规则描述',
    applicable_product_types VARCHAR(500) COMMENT '适用商品类型（JSON数组）',
    applicable_user_levels VARCHAR(500) COMMENT '适用用户等级（JSON数组）',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_rule_code (rule_code),
    INDEX idx_rule_type (rule_type),
    INDEX idx_commission_level (commission_level),
    INDEX idx_status (status),
    INDEX idx_effective_start_time (effective_start_time),
    INDEX idx_effective_end_time (effective_end_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='佣金规则表';
```

#### 业务节点说明

**创建节点**：
- 管理员创建新的佣金规则
- 系统初始化时创建基础佣金规则
- 运营活动需要时创建特殊规则

**变更节点**：
- 佣金比例调整时更新commission_rate
- 规则生效时间调整时更新时间字段
- 规则状态变更时更新status
- 适用范围调整时更新适用条件

**删除节点**：
- 佣金规则过期时逻辑删除
- 规则不再使用时清理
- 系统重构时清理无效规则

---

### 3. 佣金提现申请表 (t_promoter_withdraw)

#### 表结构
```sql
CREATE TABLE t_promoter_withdraw (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    withdraw_no VARCHAR(50) UNIQUE NOT NULL COMMENT '提现单号',
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    withdraw_amount DECIMAL(10,2) NOT NULL COMMENT '提现金额',
    withdraw_fee DECIMAL(10,2) DEFAULT 0 COMMENT '提现手续费',
    actual_amount DECIMAL(10,2) NOT NULL COMMENT '实际到账金额',
    withdraw_method VARCHAR(20) NOT NULL COMMENT '提现方式：WECHAT-微信，ALIPAY-支付宝，BANK-银行卡',
    withdraw_account VARCHAR(100) COMMENT '提现账号',
    account_name VARCHAR(50) COMMENT '账号姓名',
    bank_name VARCHAR(50) COMMENT '银行名称',
    withdraw_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '提现状态：PENDING-待审核，APPROVED-审核通过，PROCESSING-处理中，SUCCESS-成功，FAILED-失败，REJECTED-拒绝',
    apply_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    approve_time DATETIME COMMENT '审核时间',
    approve_user_id BIGINT COMMENT '审核人ID',
    approve_remark VARCHAR(500) COMMENT '审核备注',
    process_time DATETIME COMMENT '处理时间',
    complete_time DATETIME COMMENT '完成时间',
    failure_reason VARCHAR(200) COMMENT '失败原因',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_withdraw_no (withdraw_no),
    INDEX idx_promoter_id (promoter_id),
    INDEX idx_withdraw_status (withdraw_status),
    INDEX idx_withdraw_method (withdraw_method),
    INDEX idx_apply_time (apply_time),
    INDEX idx_approve_time (approve_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='佣金提现申请表';
```

#### 业务节点说明

**创建节点**：
- 推广员申请提现时创建提现申请
- 系统自动发起提现时创建记录

**变更节点**：
- 管理员审核提现时更新审核状态
- 提现处理中时更新处理状态
- 提现完成时更新完成状态和第三方信息
- 提现失败时更新失败原因

**删除节点**：
- 提现完成且长期未查询时逻辑删除
- 系统定期清理无效提现申请

---

### 4. 用户推广员关联表 (t_promoter_user_promoter_rel)

#### 表结构
```sql
CREATE TABLE t_promoter_user_promoter_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    relation_type VARCHAR(20) NOT NULL COMMENT '关系类型：DIRECT-直推，INDIRECT-间接',
    relation_level INT NOT NULL COMMENT '关系层级：1-一级，2-二级，3-三级',
    bind_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
    bind_source VARCHAR(50) COMMENT '绑定来源：INVITE_CODE-邀请码，AUTO_BIND-自动绑定，MANUAL-手动绑定',
    invite_code VARCHAR(50) COMMENT '邀请码',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '关系状态：1-有效，0-无效',
    unbind_time DATETIME COMMENT '解绑时间',
    unbind_reason VARCHAR(200) COMMENT '解绑原因',

    -- 统计信息
    contribution_amount DECIMAL(10,2) DEFAULT 0 COMMENT '贡献金额',
    contribution_orders INT DEFAULT 0 COMMENT '贡献订单数',
    last_contribution_time DATETIME COMMENT '最后贡献时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_user_promoter (user_id, promoter_id),
    INDEX idx_promoter_id (promoter_id),
    INDEX idx_relation_type (relation_type),
    INDEX idx_relation_level (relation_level),
    INDEX idx_bind_time (bind_time),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户推广员关联表';
```

#### 业务节点说明

**创建节点**：
- 用户通过邀请码注册时建立关联
- 管理员手动绑定用户和推广员关系
- 系统自动识别并建立推广关系

**变更节点**：
- 用户贡献数据更新时修改统计字段
- 关系状态变更时更新status
- 解绑关系时更新解绑信息

**删除节点**：
- 用户注销账户时清理关联关系
- 推广员注销时清理相关关联
- 系统定期清理无效关联关系

---

### 5. 推广员下线关联表 (t_promoter_promoter_downline_rel)

#### 表结构
```sql
CREATE TABLE t_promoter_promoter_downline_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    downline_promoter_id BIGINT NOT NULL COMMENT '下线推广员ID',
    relation_level INT NOT NULL COMMENT '关系层级：1-一级下线，2-二级下线，3-三级下线',
    bind_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '关系状态：1-有效，0-无效',
    unbind_time DATETIME COMMENT '解绑时间',
    unbind_reason VARCHAR(200) COMMENT '解绑原因',

    -- 贡献统计
    total_contribution DECIMAL(10,2) DEFAULT 0 COMMENT '总贡献佣金',
    month_contribution DECIMAL(10,2) DEFAULT 0 COMMENT '本月贡献佣金',
    last_contribution_time DATETIME COMMENT '最后贡献时间',

    -- 层级路径（用于快速查询上级关系）
    promoter_path VARCHAR(500) COMMENT '推广员路径（格式：1,2,3表示层级关系）',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_promoter_downline (promoter_id, downline_promoter_id),
    INDEX idx_downline_promoter_id (downline_promoter_id),
    INDEX idx_relation_level (relation_level),
    INDEX idx_bind_time (bind_time),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推广员下线关联表';
```

#### 业务节点说明

**创建节点**：
- 新推广员加入时建立上下级关系
- 推广员发展下线时自动建立关联
- 系统重建层级关系时创建记录

**变更节点**：
- 下线贡献数据更新时修改统计字段
- 关系状态变更时更新status
- 层级路径调整时更新路径信息

**删除节点**：
- 推广员注销时清理下线关联
- 系统定期清理无效关联关系

---

### 6. 佣金产生日志表 (t_promoter_commission_log)

#### 表结构
```sql
CREATE TABLE t_promoter_commission_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    commission_no VARCHAR(50) UNIQUE NOT NULL COMMENT '佣金流水号',
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    user_id BIGINT COMMENT '贡献用户ID',
    order_id BIGINT COMMENT '关联订单ID',
    commission_type VARCHAR(20) NOT NULL COMMENT '佣金类型：DIRECT-直推佣金，INDIRECT-间接佣金',
    commission_amount DECIMAL(10,2) NOT NULL COMMENT '佣金金额',
    commission_rate DECIMAL(5,4) COMMENT '佣金比例',
    order_amount DECIMAL(10,2) COMMENT '订单金额',
    rule_id BIGINT COMMENT '佣金规则ID',
    settlement_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '结算状态：PENDING-待结算，SETTLED-已结算，CANCELLED-已取消',
    settlement_time DATETIME COMMENT '结算时间',
    expire_time DATETIME COMMENT '过期时间',
    commission_source VARCHAR(200) COMMENT '佣金来源描述',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    UNIQUE KEY uk_commission_no (commission_no),
    INDEX idx_promoter_id (promoter_id),
    INDEX idx_user_id (user_id),
    INDEX idx_order_id (order_id),
    INDEX idx_commission_type (commission_type),
    INDEX idx_settlement_status (settlement_status),
    INDEX idx_settlement_time (settlement_time),
    INDEX idx_created_time (created_time),
    INDEX idx_promoter_time (promoter_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='佣金产生日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 订单完成时计算并记录佣金
- 系统定期结算佣金时记录
- 佣金调整时记录变更日志

**变更节点**：
- 佣金结算时更新结算状态
- 佣金过期时更新过期状态

**删除节点**：
- 按时间定期清理过期日志（通常保留2年）
- 佣金已结算且过期时清理

---

### 7. 佣金提现日志表 (t_promoter_withdraw_log)

#### 表结构
```sql
CREATE TABLE t_promoter_withdraw_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    withdraw_id BIGINT NOT NULL COMMENT '提现申请ID',
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    log_type VARCHAR(20) NOT NULL COMMENT '日志类型：APPLY-申请，APPROVE-审核，PROCESS-处理，COMPLETE-完成，FAIL-失败',
    withdraw_amount DECIMAL(10,2) COMMENT '提现金额',
    withdraw_fee DECIMAL(10,2) COMMENT '手续费',
    actual_amount DECIMAL(10,2) COMMENT '实际到账金额',
    withdraw_method VARCHAR(20) COMMENT '提现方式',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',
    operation_result VARCHAR(20) COMMENT '操作结果：SUCCESS-成功，FAILED-失败',
    error_message VARCHAR(500) COMMENT '错误信息',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    operation_remark VARCHAR(500) COMMENT '操作备注',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_withdraw_id (withdraw_id),
    INDEX idx_promoter_id (promoter_id),
    INDEX idx_log_type (log_type),
    INDEX idx_operation_result (operation_result),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_promoter_time (promoter_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='佣金提现日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 推广员申请提现时记录申请日志
- 管理员审核提现时记录审核日志
- 提现处理时记录处理日志
- 提现完成或失败时记录结果日志

**变更节点**：
- 通常提现日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 系统存储空间不足时清理最旧的日志

---

## 数据管理策略

### 数据清理策略
1. **推广员基础数据**：永久保留，除非推广员主动注销
2. **佣金规则数据**：永久保留，除非规则明确废弃
3. **提现申请数据**：永久保留，用于财务记录
4. **用户推广员关联**：随用户或推广员注销时清理
5. **下线关联数据**：随推广员注销时清理
6. **佣金产生日志**：保留2年，超过2年的数据归档
7. **提现日志**：保留1年，超过1年的数据清理

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：推广员信息和佣金数据使用Redis缓存

### 安全策略
1. **佣金操作审计**：所有佣金产生和提现必须记录操作日志
2. **提现安全**：提现相关信息需要加密存储
3. **权限控制**：推广员管理和佣金操作需要严格的权限验证
4. **数据一致性**：通过事务保证佣金数据的一致性
