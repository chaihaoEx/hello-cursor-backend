# 用户积分模块表定义

## 概述
用户积分模块包含用户积分账户管理、积分统计缓存、积分获得记录、积分消费记录以及积分过期记录等核心功能。支持积分的多种获得和消费场景，通过缓存表提升查询性能。

## 表结构定义

### 1. 用户积分账户表 (t_points_user_points)

#### 表结构
```sql
CREATE TABLE t_points_user_points (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    total_points BIGINT NOT NULL DEFAULT 0 COMMENT '总积分',
    available_points BIGINT NOT NULL DEFAULT 0 COMMENT '可用积分',
    frozen_points BIGINT NOT NULL DEFAULT 0 COMMENT '冻结积分',
    expired_points BIGINT NOT NULL DEFAULT 0 COMMENT '已过期积分',
    total_earned BIGINT NOT NULL DEFAULT 0 COMMENT '累计获得积分',
    total_consumed BIGINT NOT NULL DEFAULT 0 COMMENT '累计消费积分',
    last_earn_time DATETIME COMMENT '最后获得积分时间',
    last_consume_time DATETIME COMMENT '最后消费积分时间',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '账户状态：1-正常，0-冻结',
    level VARCHAR(20) DEFAULT 'NORMAL' COMMENT '积分等级：NORMAL-普通，VIP-VIP，SVIP-SVIP',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_level (level),
    INDEX idx_available_points (available_points),
    INDEX idx_last_earn_time (last_earn_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户积分账户表';
```

#### 业务节点说明

**创建节点**：
- 用户首次注册时自动创建积分账户
- 用户首次获得积分时创建账户记录
- 管理员手动为用户创建积分账户

**变更节点**：
- 用户获得积分时更新总积分和可用积分
- 用户消费积分时扣减可用积分
- 积分冻结和解冻时更新冻结积分
- 积分过期时更新过期积分和可用积分
- 用户等级升级时更新level字段

**删除节点**：
- 用户注销账户时清理积分账户
- 系统定期清理长期未使用的积分账户

---

### 2. 积分统计缓存表 (t_points_points_stats_cache)

#### 表结构
```sql
CREATE TABLE t_points_points_stats_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    daily_earn BIGINT DEFAULT 0 COMMENT '今日获得积分',
    weekly_earn BIGINT DEFAULT 0 COMMENT '本周获得积分',
    monthly_earn BIGINT DEFAULT 0 COMMENT '本月获得积分',
    daily_consume BIGINT DEFAULT 0 COMMENT '今日消费积分',
    weekly_consume BIGINT DEFAULT 0 COMMENT '本周消费积分',
    monthly_consume BIGINT DEFAULT 0 COMMENT '本月消费积分',
    earn_count_today INT DEFAULT 0 COMMENT '今日获得次数',
    consume_count_today INT DEFAULT 0 COMMENT '今日消费次数',
    earn_count_week INT DEFAULT 0 COMMENT '本周获得次数',
    consume_count_week INT DEFAULT 0 COMMENT '本周消费次数',
    earn_count_month INT DEFAULT 0 COMMENT '本月获得次数',
    consume_count_month INT DEFAULT 0 COMMENT '本月消费次数',
    stats_date DATE COMMENT '统计日期',
    last_update_time DATETIME NOT NULL COMMENT '最后更新时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_stats_date (stats_date),
    INDEX idx_last_update_time (last_update_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分统计缓存表';
```

#### 业务节点说明

**创建节点**：
- 用户积分账户创建时同步创建统计缓存
- 用户首次获得/消费积分时创建统计记录

**变更节点**：
- 用户获得积分时更新获得统计数据
- 用户消费积分时更新消费统计数据
- 每日定时任务重置日统计数据
- 每周/月定时任务更新周/月统计数据

**删除节点**：
- 用户积分账户删除时清理统计缓存
- 系统定期清理过期统计数据

---

### 3. 积分获得日志表 (t_points_earn_log)

#### 表结构
```sql
CREATE TABLE t_points_earn_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    earn_type VARCHAR(50) NOT NULL COMMENT '获得类型：REGISTER-注册，LOGIN-登录，ORDER-订单，SHARE-分享，INVITE-邀请',
    earn_channel VARCHAR(50) COMMENT '获得渠道：WX_MINI-小程序，WX_OFFICIAL-公众号，APP-APP',
    earn_amount BIGINT NOT NULL COMMENT '获得积分数量',
    earn_reason VARCHAR(200) COMMENT '获得原因描述',
    related_id BIGINT COMMENT '关联ID（订单ID、分享ID等）',
    related_type VARCHAR(50) COMMENT '关联类型：ORDER-订单，SHARE-分享，INVITE-邀请',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',
    order_amount DECIMAL(10,2) COMMENT '订单金额（订单获得积分时使用）',
    expire_time DATETIME COMMENT '积分过期时间',
    is_expired TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否已过期：0-未过期，1-已过期',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_earn_type (earn_type),
    INDEX idx_earn_channel (earn_channel),
    INDEX idx_related_id_type (related_id, related_type),
    INDEX idx_expire_time (expire_time),
    INDEX idx_is_expired (is_expired),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分获得日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户注册时记录注册积分获得日志
- 用户每日登录时记录登录积分日志
- 用户完成订单时记录订单积分日志
- 用户分享内容时记录分享积分日志
- 用户邀请好友时记录邀请积分日志

**变更节点**：
- 积分过期时更新is_expired状态
- 补充获得信息时更新相关字段

**删除节点**：
- 按时间定期清理过期日志（通常保留2年）
- 用户注销账户时清理相关日志

---

### 4. 积分消费日志表 (t_points_consume_log)

#### 表结构
```sql
CREATE TABLE t_points_consume_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    consume_type VARCHAR(50) NOT NULL COMMENT '消费类型：EXCHANGE-兑换，ORDER_PAY-订单支付，GAME-游戏，LOTTERY-抽奖',
    consume_channel VARCHAR(50) COMMENT '消费渠道：WX_MINI-小程序，WX_OFFICIAL-公众号，APP-APP',
    consume_amount BIGINT NOT NULL COMMENT '消费积分数量',
    consume_reason VARCHAR(200) COMMENT '消费原因描述',
    related_id BIGINT COMMENT '关联ID（订单ID、商品ID等）',
    related_type VARCHAR(50) COMMENT '关联类型：ORDER-订单，PRODUCT-商品，GAME-游戏',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',
    balance_before BIGINT NOT NULL COMMENT '消费前余额',
    balance_after BIGINT NOT NULL COMMENT '消费后余额',
    refund_status TINYINT(1) NOT NULL DEFAULT 0 COMMENT '退款状态：0-未退款，1-已退款',
    refund_time DATETIME COMMENT '退款时间',
    refund_amount BIGINT DEFAULT 0 COMMENT '退款积分数量',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_consume_type (consume_type),
    INDEX idx_consume_channel (consume_channel),
    INDEX idx_related_id_type (related_id, related_type),
    INDEX idx_refund_status (refund_status),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分消费日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户使用积分兑换商品时记录消费日志
- 用户使用积分支付订单时记录消费日志
- 用户参与游戏消费积分时记录日志
- 用户抽奖消费积分时记录日志

**变更节点**：
- 积分消费退款时更新refund_status和refund相关字段
- 补充消费信息时更新相关字段

**删除节点**：
- 按时间定期清理过期日志（通常保留2年）
- 用户注销账户时清理相关日志

---

### 5. 积分过期日志表 (t_points_expire_log)

#### 表结构
```sql
CREATE TABLE t_points_expire_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    earn_log_id BIGINT NOT NULL COMMENT '关联获得日志ID',
    expire_amount BIGINT NOT NULL COMMENT '过期积分数量',
    expire_reason VARCHAR(200) COMMENT '过期原因',
    earn_time DATETIME NOT NULL COMMENT '获得时间',
    original_expire_time DATETIME NOT NULL COMMENT '原始过期时间',
    actual_expire_time DATETIME NOT NULL COMMENT '实际过期时间',
    days_since_earn INT COMMENT '获得后天数',
    balance_before BIGINT NOT NULL COMMENT '过期前余额',
    balance_after BIGINT NOT NULL COMMENT '过期后余额',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_earn_log_id (earn_log_id),
    INDEX idx_actual_expire_time (actual_expire_time),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分过期日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 积分定期过期时记录过期日志
- 系统检测到积分过期时自动创建日志
- 积分因特殊原因提前过期时记录日志

**变更节点**：
- 通常积分过期日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 系统存储空间不足时清理最旧的日志

---

## 数据管理策略

### 数据清理策略
1. **积分账户数据**：永久保留，除非用户主动注销
2. **积分统计缓存**：随用户账户生命周期清理
3. **积分获得日志**：保留2年，超过2年的数据归档
4. **积分消费日志**：保留2年，超过2年的数据归档
5. **积分过期日志**：保留1年，超过1年的数据清理

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：用户积分信息使用Redis缓存

### 安全策略
1. **积分操作审计**：所有积分获得和消费必须记录详细日志
2. **防刷机制**：积分获得需要防刷机制
3. **数据一致性**：通过事务保证积分账户数据的一致性
4. **权限控制**：积分管理操作需要严格的权限验证
