# 用户模块表定义

## 概述
用户模块包含微信用户管理、管理员账户管理、用户资料扩展、收货地址管理以及相关的登录日志和操作日志等核心功能。

## 表结构定义

### 1. 微信用户表 (t_user_wechat_user)

#### 表结构
```sql
CREATE TABLE t_user_wechat_user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    openid VARCHAR(100) NOT NULL COMMENT '微信openid',
    unionid VARCHAR(100) COMMENT '微信unionid',
    nickname VARCHAR(100) COMMENT '微信昵称',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    gender TINYINT(1) COMMENT '性别：1-男，2-女，0-未知',
    province VARCHAR(50) COMMENT '省份',
    city VARCHAR(50) COMMENT '城市',
    country VARCHAR(50) COMMENT '国家',
    language VARCHAR(20) COMMENT '语言',
    phone VARCHAR(20) COMMENT '绑定手机号',
    email VARCHAR(100) COMMENT '绑定邮箱',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '用户状态：1-正常，0-禁用',
    last_login_time DATETIME COMMENT '最后登录时间',
    register_source VARCHAR(50) COMMENT '注册来源：WX_MINI-微信小程序，WX_OFFICIAL-微信公众号',
    subscribe_status TINYINT(1) DEFAULT 1 COMMENT '关注状态：1-已关注，0-未关注',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_openid (openid),
    UNIQUE KEY uk_unionid (unionid),
    INDEX idx_phone (phone),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_last_login_time (last_login_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='微信用户表';
```

#### 业务节点说明

**创建节点**：
- 用户首次通过微信授权登录时创建用户记录
- 用户扫码关注公众号时创建用户记录
- 管理员在后台手动创建用户时
- 系统批量导入用户数据时

**变更节点**：
- 用户更新微信资料时同步更新昵称、头像等信息
- 用户绑定手机号或邮箱时更新联系方式
- 用户状态变更时更新status字段
- 用户登录时更新last_login_time
- 用户关注/取关公众号时更新subscribe_status

**删除节点**：
- 用户主动注销账户时逻辑删除（is_deleted=1）
- 管理员禁用违规用户时逻辑删除
- 系统定期清理长期未登录的僵尸用户

---

### 2. 管理员表 (t_user_admin)

#### 表结构
```sql
CREATE TABLE t_user_admin (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    username VARCHAR(50) NOT NULL COMMENT '登录用户名',
    password VARCHAR(255) NOT NULL COMMENT '登录密码（加密存储）',
    real_name VARCHAR(50) COMMENT '真实姓名',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    role_code VARCHAR(50) NOT NULL COMMENT '角色代码：SUPER_ADMIN-超级管理员，ADMIN-管理员，OPERATOR-运营员',
    department VARCHAR(100) COMMENT '所属部门',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-禁用',
    last_login_time DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(50) COMMENT '最后登录IP',
    login_count INT DEFAULT 0 COMMENT '登录次数统计',
    password_reset_time DATETIME COMMENT '密码重置时间',
    is_locked TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否锁定：0-未锁定，1-已锁定',
    lock_time DATETIME COMMENT '锁定时间',
    unlock_time DATETIME COMMENT '解锁时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_username (username),
    INDEX idx_phone (phone),
    INDEX idx_email (email),
    INDEX idx_role_code (role_code),
    INDEX idx_status (status),
    INDEX idx_department (department),
    INDEX idx_last_login_time (last_login_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员表';
```

#### 业务节点说明

**创建节点**：
- 系统初始化时创建超级管理员账户
- 管理员在后台添加新的管理员账户
- 部门负责人审批通过后创建新管理员
- 角色权限调整时创建对应角色的管理员

**变更节点**：
- 管理员修改个人信息时更新real_name、phone、email
- 管理员角色调整时更新role_code
- 管理员登录时更新last_login_time、last_login_ip、login_count
- 密码重置时更新password_reset_time
- 账户被锁定时更新is_locked、lock_time
- 账户解锁时更新unlock_time

**删除节点**：
- 管理员离职时逻辑删除账户
- 管理员违规严重时永久禁用账户
- 部门调整时清理不再需要的管理员账户

---

### 3. 用户资料表 (t_user_user_profile)

#### 表结构
```sql
CREATE TABLE t_user_user_profile (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '关联用户ID',
    birthday DATE COMMENT '生日',
    occupation VARCHAR(100) COMMENT '职业',
    education VARCHAR(50) COMMENT '学历',
    income_level VARCHAR(50) COMMENT '收入水平',
    interests TEXT COMMENT '兴趣爱好（JSON格式）',
    preferences TEXT COMMENT '偏好设置（JSON格式）',
    signature VARCHAR(200) COMMENT '个性签名',
    website VARCHAR(200) COMMENT '个人网站',
    wechat_id VARCHAR(100) COMMENT '微信号',
    qq VARCHAR(20) COMMENT 'QQ号',
    emergency_contact VARCHAR(50) COMMENT '紧急联系人',
    emergency_phone VARCHAR(20) COMMENT '紧急联系电话',
    id_card_type VARCHAR(20) COMMENT '证件类型',
    id_card_no VARCHAR(50) COMMENT '证件号码（加密存储）',
    marital_status VARCHAR(20) COMMENT '婚姻状况',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_user_id (user_id),
    INDEX idx_birthday (birthday),
    INDEX idx_occupation (occupation),
    INDEX idx_education (education),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户资料表';
```

#### 业务节点说明

**创建节点**：
- 用户首次完善个人资料时创建记录
- 用户绑定身份信息时创建资料记录
- 系统根据用户行为自动生成基础资料

**变更节点**：
- 用户修改个人基本信息时更新对应字段
- 用户完善更多资料时补充相关信息
- 用户隐私设置调整时更新公开程度
- 用户偏好改变时更新preferences字段

**删除节点**：
- 用户注销账户时同步删除个人资料
- 用户要求删除敏感信息时清理相关字段
- 系统定期清理无效的资料记录

---

### 4. 用户地址表 (t_user_address)

#### 表结构
```sql
CREATE TABLE t_user_address (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '关联用户ID',
    receiver_name VARCHAR(50) NOT NULL COMMENT '收货人姓名',
    receiver_phone VARCHAR(20) NOT NULL COMMENT '收货人电话',
    province VARCHAR(50) NOT NULL COMMENT '省份',
    city VARCHAR(50) NOT NULL COMMENT '城市',
    district VARCHAR(50) NOT NULL COMMENT '区县',
    street VARCHAR(100) NOT NULL COMMENT '街道',
    address_detail VARCHAR(200) NOT NULL COMMENT '详细地址',
    postal_code VARCHAR(10) COMMENT '邮政编码',
    latitude DECIMAL(10,7) COMMENT '纬度',
    longitude DECIMAL(10,7) COMMENT '经度',
    is_default TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否默认地址：0-否，1-是',
    address_type VARCHAR(20) DEFAULT 'HOME' COMMENT '地址类型：HOME-家庭，COMPANY-公司，OTHER-其他',
    address_label VARCHAR(50) COMMENT '地址标签',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-禁用',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_user_default (user_id, is_default),
    INDEX idx_province_city (province, city),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

#### 业务节点说明

**创建节点**：
- 用户首次添加收货地址时创建记录
- 用户下单时需要新增地址时创建
- 系统根据用户位置自动推荐地址时创建
- 用户导入地址簿时批量创建

**变更节点**：
- 用户修改收货地址信息时更新相关字段
- 用户设置默认地址时更新is_default字段
- 用户调整地址类型时更新address_type
- 用户更新地理位置时更新latitude、longitude

**删除节点**：
- 用户删除不再使用的地址时逻辑删除
- 系统定期清理长期未使用的地址
- 用户注销账户时清理所有地址记录

---

### 5. 用户登录日志表 (t_user_login_log)

#### 表结构
```sql
CREATE TABLE t_user_login_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    login_type VARCHAR(20) NOT NULL COMMENT '登录类型：WX_MINI-微信小程序，WX_OFFICIAL-微信公众号，ACCOUNT-账号密码',
    login_device VARCHAR(50) COMMENT '登录设备',
    login_ip VARCHAR(50) COMMENT '登录IP地址',
    login_location VARCHAR(100) COMMENT '登录地点',
    login_result TINYINT(1) NOT NULL COMMENT '登录结果：1-成功，0-失败',
    fail_reason VARCHAR(200) COMMENT '失败原因',
    session_id VARCHAR(100) COMMENT '会话ID',
    logout_time DATETIME COMMENT '登出时间',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_login_type (login_type),
    INDEX idx_login_result (login_result),
    INDEX idx_login_ip (login_ip),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户登录日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户成功登录系统时记录登录日志
- 用户登录失败时记录失败日志
- 用户通过不同方式登录时记录对应日志
- 系统检测到异常登录时记录安全日志

**变更节点**：
- 用户正常登出时更新logout_time
- 登录会话过期时更新相关状态
- 系统补充登录信息时更新login_location等字段

**删除节点**：
- 按时间定期清理过期登录日志（通常保留6个月）
- 用户注销账户时清理相关登录记录
- 系统存储优化时清理最旧的登录日志

---

### 6. 管理员操作日志表 (t_user_admin_operation_log)

#### 表结构
```sql
CREATE TABLE t_user_admin_operation_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    admin_id BIGINT NOT NULL COMMENT '管理员ID',
    admin_name VARCHAR(100) COMMENT '管理员姓名',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型：CREATE-创建，UPDATE-更新，DELETE-删除，LOGIN-登录，LOGOUT-登出',
    operation_module VARCHAR(50) NOT NULL COMMENT '操作模块：USER-用户管理，PRODUCT-商品管理，ORDER-订单管理',
    operation_action VARCHAR(100) NOT NULL COMMENT '具体操作：USER_CREATE-创建用户，PRODUCT_UPDATE-更新商品',
    operation_desc VARCHAR(500) COMMENT '操作描述',
    target_id BIGINT COMMENT '操作目标ID',
    target_type VARCHAR(50) COMMENT '操作目标类型：USER-用户，PRODUCT-商品，ORDER-订单',
    old_value TEXT COMMENT '操作前的值',
    new_value TEXT COMMENT '操作后的值',
    operation_ip VARCHAR(50) COMMENT '操作IP地址',
    operation_result TINYINT(1) NOT NULL DEFAULT 1 COMMENT '操作结果：1-成功，0-失败',
    error_message VARCHAR(500) COMMENT '错误信息',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_admin_id (admin_id),
    INDEX idx_operation_type (operation_type),
    INDEX idx_operation_module (operation_module),
    INDEX idx_target_id_type (target_id, target_type),
    INDEX idx_operation_result (operation_result),
    INDEX idx_created_time (created_time),
    INDEX idx_admin_time (admin_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员操作日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 管理员登录系统时记录登录日志
- 管理员执行用户管理操作时记录操作日志
- 管理员修改商品信息时记录变更日志
- 管理员处理订单时记录操作日志
- 系统检测到管理员异常操作时记录安全日志

**变更节点**：
- 通常管理员操作日志不进行变更，以保证日志的不可篡改性
- 特殊情况下可能需要补充操作上下文信息

**删除节点**：
- 按时间定期清理过期操作日志（通常保留1-2年）
- 管理员离职时可选择性清理相关操作日志
- 系统存储空间不足时清理最旧的操作日志
- 合规要求下删除敏感操作日志

---

## 数据管理策略

### 数据清理策略
1. **用户基础数据**：永久保留，除非用户主动注销
2. **用户资料数据**：随用户账户一起清理
3. **用户地址数据**：保留2年，超过2年的清理
4. **登录日志**：保留6个月，超过6个月的数据归档
5. **管理员操作日志**：保留2年，超过2年的数据归档

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：用户基础信息使用Redis缓存

### 安全策略
1. **敏感信息加密**：手机号、邮箱、身份证等敏感信息加密存储
2. **访问控制**：管理员操作需要严格的权限验证
3. **审计追踪**：重要用户操作必须记录操作日志
4. **异常监控**：异常登录和操作需要实时监控和告警
5. **数据脱敏**：日志中的敏感信息需要脱敏处理
