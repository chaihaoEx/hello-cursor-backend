
# 数据库设计大纲

## 基础说明
这是一个在线盲盒抽奖小程序的数据库设计

## 设计原则
- **标准化**：统一字段命名、数据类型、索引规范
- **可扩展性**：预留字段和表结构扩展空间
- **性能优先**：合理使用索引、冗余设计
- **数据一致性**：通过约束和事务保证数据完整性

## 表类型分类

### 1. 实体表（Entity Tables）
**命名规范**：`t_{业务模块}_{实体名}`
**示例**：
- `t_user_user` - 用户表
- `t_box_blind_box` - 盲盒表
- `t_batch_box_batch` - 批次表

### 2. 关联关系表（Relation Tables）
**命名规范**：`t_{模块}_{主实体}_{从实体}_rel`
**示例**：
- `t_user_user_box_rel` - 用户盲盒关联表
- `t_batch_batch_user_rel` - 批次用户关联表

### 3. 冗余数据表（Redundant Tables）
**命名规范**：`t_{模块}_{实体}_{用途}_cache`
**示例**：
- `t_box_box_stock_cache` - 盲盒库存缓存表
- `t_batch_batch_sale_cache` - 批次销售缓存表

### 4. 日志记录表（Log Tables）
**命名规范**：`t_{模块}_{操作}_log`
**示例**：
- `t_box_draw_log` - 抽奖日志表
- `t_user_login_log` - 用户登录日志表
- `t_batch_purchase_log` - 批次购买日志表

## 标准化字段规范

### 必备字段（所有实体表）
```sql
-- 主键ID
id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',

-- 审计字段
created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
created_by VARCHAR(100) COMMENT '创建人',
updated_by VARCHAR(100) COMMENT '更新人',

-- 状态字段
is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁'
```

### 可选审计字段（根据业务需要）
```sql
-- 扩展审计
tenant_id BIGINT COMMENT '租户ID，多租户场景使用',
business_id VARCHAR(100) COMMENT '业务ID，用于业务追踪',
source_channel VARCHAR(50) COMMENT '来源渠道'
```

## 数据类型规范

#### 常用数据类型选择
- **ID字段**：`BIGINT`（支持更大规模数据）
- **金额字段**：`DECIMAL(10,2)`（避免浮点精度问题）
- **状态枚举**：`TINYINT(1)`（节省存储空间）
- **短文本**：`VARCHAR(100)`（根据实际长度调整）
- **长文本**：`TEXT`（描述、备注等）
- **时间字段**：`DATETIME`（支持毫秒精度）

## 索引设计规范

### 必备索引
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id),

-- 审计字段索引
INDEX idx_created_time (created_time),
INDEX idx_updated_time (updated_time),
INDEX idx_is_deleted (is_deleted),

-- 业务常用查询索引（根据实际查询需求设计）
INDEX idx_business_key (business_field),
INDEX idx_status_time (status, created_time)
```

### 复合索引原则
- **最左前缀原则**：将查询频率高的字段放在最左边
- **区分度优先**：高区分度的字段放在前面
- **覆盖索引**：尽量使用覆盖索引减少回表

## 约束设计规范

### 数据完整性约束
```sql
-- 唯一约束
UNIQUE KEY uk_business_key (business_field),

-- 检查约束
CHECK (amount >= 0),
CHECK (status IN ('ACTIVE', 'INACTIVE', 'DELETED'))
```

## 逻辑删除规范

### 删除标记字段
```sql
is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '删除标记：0-未删除，1-已删除'
```

### 查询过滤
```sql
-- 正常查询
SELECT * FROM table_name WHERE is_deleted = 0;

-- 包含已删除数据（管理员查询）
SELECT * FROM table_name;
```

### 索引优化
```sql
-- 为删除标记创建复合索引
INDEX idx_is_deleted_status (is_deleted, status);
```

## 分表分库规划

### 垂直分表
- **大表拆分**：将不常用字段拆分到扩展表
- **历史表分离**：将历史数据移到历史表

### 水平分表
- **按时间分表**：日志表按月/年分表
- **按业务分表**：按用户ID、批次ID等分表

## 性能优化预案

### 查询优化
- **分页查询**：大表必须使用LIMIT分页
- **索引覆盖**：设计覆盖常用查询的复合索引
- **查询重写**：避免复杂子查询，使用JOIN优化

### 写入优化
- **批量操作**：支持批量插入、更新
- **异步处理**：日志表可异步写入
- **分批提交**：大批量操作分批提交

## 监控告警规范

### 关键指标监控
- **表数据量**：监控大表数据增长趋势
- **索引使用率**：监控索引使用情况
- **慢查询**：记录执行时间超过阈值的查询
- **死锁检测**：监控数据库死锁情况

## 版本管理

### 数据库版本控制
- **Flyway/Liquibase**：使用数据库迁移工具
- **版本号规范**：`V{年月日}_{序号}_{描述}`
- **回滚策略**：重要变更提供回滚脚本