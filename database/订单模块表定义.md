# 订单模块表定义

## 概述
订单模块包含订单生命周期管理、支付信息管理、退款处理、线下领取记录以及订单商品明细管理等核心功能。支持线上订单和线下消费券的完整订单流程，通过关联表管理订单商品关系。

## 表结构定义

### 1. 订单表 (t_order_order)

#### 表结构
```sql
CREATE TABLE t_order_order (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    order_type VARCHAR(20) NOT NULL DEFAULT 'NORMAL' COMMENT '订单类型：NORMAL-普通订单，GIFT-赠送订单，GROUP-团购订单',
    order_source VARCHAR(20) COMMENT '订单来源：WX_MINI-小程序，WX_OFFICIAL-公众号，APP-APP',
    order_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '订单状态：PENDING-待支付，PAID-已支付，SHIPPING-发货中，DELIVERED-已发货，RECEIVED-已收货，COMPLETED-已完成，CANCELLED-已取消，REFUNDING-退款中，REFUNDED-已退款',
    payment_status VARCHAR(20) NOT NULL DEFAULT 'UNPAID' COMMENT '支付状态：UNPAID-未支付，PAID-已支付，PARTIAL_REFUND-部分退款，FULL_REFUND-全额退款',
    shipping_status VARCHAR(20) DEFAULT 'PENDING' COMMENT '发货状态：PENDING-待发货，SHIPPED-已发货，DELIVERED-已送达，RECEIVED-已签收',

    -- 商品信息
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠金额',
    shipping_fee DECIMAL(10,2) DEFAULT 0 COMMENT '运费',
    points_used BIGINT DEFAULT 0 COMMENT '使用积分',
    points_amount DECIMAL(10,2) DEFAULT 0 COMMENT '积分抵扣金额',
    final_amount DECIMAL(10,2) NOT NULL COMMENT '实际支付金额',

    -- 收货信息
    receiver_name VARCHAR(50) COMMENT '收货人姓名',
    receiver_phone VARCHAR(20) COMMENT '收货人电话',
    receiver_address TEXT COMMENT '收货地址',
    receiver_postal_code VARCHAR(10) COMMENT '邮政编码',

    -- 时间信息
    order_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '下单时间',
    pay_time DATETIME COMMENT '支付时间',
    ship_time DATETIME COMMENT '发货时间',
    receive_time DATETIME COMMENT '收货时间',
    complete_time DATETIME COMMENT '完成时间',
    cancel_time DATETIME COMMENT '取消时间',

    -- 物流信息
    shipping_company VARCHAR(50) COMMENT '物流公司',
    tracking_number VARCHAR(50) COMMENT '物流单号',
    delivery_time DATETIME COMMENT '送达时间',

    -- 备注信息
    user_remark VARCHAR(500) COMMENT '用户备注',
    admin_remark VARCHAR(500) COMMENT '管理员备注',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_order_no (order_no),
    INDEX idx_user_id (user_id),
    INDEX idx_order_status (order_status),
    INDEX idx_payment_status (payment_status),
    INDEX idx_shipping_status (shipping_status),
    INDEX idx_order_time (order_time),
    INDEX idx_pay_time (pay_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted),
    INDEX idx_user_status (user_id, order_status),
    INDEX idx_status_time (order_status, order_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

#### 业务节点说明

**创建节点**：
- 用户提交购物车商品时创建订单
- 用户购买单个商品时创建订单
- 系统自动创建赠送订单
- 用户参与团购时创建团购订单

**变更节点**：
- 用户支付成功时更新支付状态和时间
- 订单发货时更新发货状态和物流信息
- 用户确认收货时更新收货状态
- 订单取消时更新订单状态
- 管理员修改订单信息时更新相关字段

**删除节点**：
- 订单长期未支付且过期时逻辑删除
- 用户要求删除历史订单时逻辑删除
- 系统定期清理无效订单

---

### 2. 支付记录表 (t_order_payment)

#### 表结构
```sql
CREATE TABLE t_order_payment (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    payment_no VARCHAR(50) UNIQUE NOT NULL COMMENT '支付流水号',
    payment_method VARCHAR(20) NOT NULL COMMENT '支付方式：WECHAT-微信支付，ALIPAY-支付宝，POINTS-积分支付，MIXED-混合支付',
    payment_channel VARCHAR(20) COMMENT '支付渠道：WX_MINI-微信小程序，WX_OFFICIAL-微信公众号',
    payment_amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
    points_used BIGINT DEFAULT 0 COMMENT '使用积分数量',
    cash_amount DECIMAL(10,2) DEFAULT 0 COMMENT '现金支付金额',
    payment_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '支付状态：PENDING-待支付，SUCCESS-支付成功，FAILED-支付失败，CANCELLED-已取消，REFUNDING-退款中，REFUNDED-已退款',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',
    payment_time DATETIME COMMENT '支付完成时间',
    failure_reason VARCHAR(200) COMMENT '支付失败原因',
    refund_amount DECIMAL(10,2) DEFAULT 0 COMMENT '已退款金额',
    refund_time DATETIME COMMENT '退款时间',

    -- 第三方支付信息
    prepay_id VARCHAR(100) COMMENT '预支付ID',
    nonce_str VARCHAR(50) COMMENT '随机字符串',
    sign VARCHAR(100) COMMENT '签名',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_payment_no (payment_no),
    INDEX idx_order_id (order_id),
    INDEX idx_payment_method (payment_method),
    INDEX idx_payment_status (payment_status),
    INDEX idx_transaction_id (transaction_id),
    INDEX idx_payment_time (payment_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付记录表';
```

#### 业务节点说明

**创建节点**：
- 用户发起支付时创建支付记录
- 订单创建后自动生成支付记录
- 混合支付时创建多条支付记录

**变更节点**：
- 支付成功时更新支付状态和第三方信息
- 支付失败时更新失败原因
- 发起退款时更新退款相关字段
- 退款成功时更新退款状态

**删除节点**：
- 支付失败且长期未处理的记录删除
- 订单删除时同步删除支付记录

---

### 3. 退款申请表 (t_order_refund)

#### 表结构
```sql
CREATE TABLE t_order_refund (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    refund_no VARCHAR(50) UNIQUE NOT NULL COMMENT '退款单号',
    refund_type VARCHAR(20) NOT NULL COMMENT '退款类型：FULL-全额退款，PARTIAL-部分退款',
    refund_reason VARCHAR(100) NOT NULL COMMENT '退款原因',
    refund_amount DECIMAL(10,2) NOT NULL COMMENT '退款金额',
    points_refund BIGINT DEFAULT 0 COMMENT '退还积分',
    refund_method VARCHAR(20) COMMENT '退款方式：ORIGINAL-原路退回，BALANCE-余额',
    refund_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '退款状态：PENDING-待审核，APPROVED-审核通过，REJECTED-审核拒绝，PROCESSING-处理中，SUCCESS-退款成功，FAILED-退款失败',
    apply_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '申请时间',
    approve_time DATETIME COMMENT '审核时间',
    approve_user_id BIGINT COMMENT '审核人ID',
    approve_remark VARCHAR(500) COMMENT '审核备注',
    process_time DATETIME COMMENT '处理时间',
    complete_time DATETIME COMMENT '完成时间',
    failure_reason VARCHAR(200) COMMENT '失败原因',

    -- 退款商品信息
    refund_items TEXT COMMENT '退款商品明细（JSON格式）',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_refund_no (refund_no),
    INDEX idx_order_id (order_id),
    INDEX idx_refund_type (refund_type),
    INDEX idx_refund_status (refund_status),
    INDEX idx_apply_time (apply_time),
    INDEX idx_approve_time (approve_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='退款申请表';
```

#### 业务节点说明

**创建节点**：
- 用户申请退款时创建退款申请
- 系统自动发起退款时创建记录
- 订单取消时自动创建退款申请

**变更节点**：
- 管理员审核退款时更新审核状态
- 退款处理中时更新处理状态
- 退款完成时更新完成状态
- 退款失败时更新失败原因

**删除节点**：
- 退款完成且长期未查询时逻辑删除
- 系统定期清理无效退款申请

---

### 4. 订单领取记录表 (t_order_pickup_record)

#### 表结构
```sql
CREATE TABLE t_order_pickup_record (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    pickup_no VARCHAR(50) UNIQUE NOT NULL COMMENT '领取单号',
    pickup_type VARCHAR(20) NOT NULL COMMENT '领取类型：STORE-门店领取，EXPRESS-快递领取，VIRTUAL-虚拟领取',
    pickup_status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT '领取状态：PENDING-待领取，PARTIAL-部分领取，COMPLETED-已完成，CANCELLED-已取消',
    total_items INT NOT NULL COMMENT '商品总件数',
    picked_items INT DEFAULT 0 COMMENT '已领取件数',
    pickup_time DATETIME COMMENT '领取时间',
    pickup_user_id BIGINT COMMENT '领取人ID',
    pickup_user_name VARCHAR(100) COMMENT '领取人姓名',
    pickup_user_phone VARCHAR(20) COMMENT '领取人电话',
    pickup_location VARCHAR(200) COMMENT '领取地点',
    pickup_remark VARCHAR(500) COMMENT '领取备注',

    -- 门店信息（门店领取时使用）
    store_id BIGINT COMMENT '门店ID',
    store_name VARCHAR(100) COMMENT '门店名称',
    store_address VARCHAR(200) COMMENT '门店地址',
    staff_id BIGINT COMMENT '服务人员ID',
    staff_name VARCHAR(50) COMMENT '服务人员姓名',

    -- 快递信息（快递领取时使用）
    courier_company VARCHAR(50) COMMENT '快递公司',
    tracking_number VARCHAR(50) COMMENT '快递单号',
    delivery_time DATETIME COMMENT '投递时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_pickup_no (pickup_no),
    INDEX idx_order_id (order_id),
    INDEX idx_pickup_type (pickup_type),
    INDEX idx_pickup_status (pickup_status),
    INDEX idx_store_id (store_id),
    INDEX idx_pickup_time (pickup_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单领取记录表';
```

#### 业务节点说明

**创建节点**：
- 订单支付成功后自动创建领取记录
- 用户选择领取方式时创建相应记录
- 订单发货时创建快递领取记录

**变更节点**：
- 商品部分领取时更新领取状态和数量
- 商品全部领取完成时更新完成状态
- 领取信息变更时更新相关字段
- 取消领取时更新取消状态

**删除节点**：
- 领取完成且长期未查询时逻辑删除
- 订单取消时同步删除领取记录

---

### 5. 订单商品关联表 (t_order_order_item_rel)

#### 表结构
```sql
CREATE TABLE t_order_order_item_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    sku_id BIGINT NOT NULL COMMENT 'SKU ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    product_name VARCHAR(200) NOT NULL COMMENT '商品名称',
    sku_name VARCHAR(200) COMMENT 'SKU名称',
    product_image VARCHAR(500) COMMENT '商品图片',
    quantity INT NOT NULL COMMENT '购买数量',
    unit_price DECIMAL(10,2) NOT NULL COMMENT '单价',
    total_price DECIMAL(10,2) NOT NULL COMMENT '总价',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠金额',
    final_price DECIMAL(10,2) NOT NULL COMMENT '实际支付价格',

    -- 商品规格信息
    spec_combination TEXT COMMENT '规格组合（JSON格式）',

    -- 退款信息
    refund_quantity INT DEFAULT 0 COMMENT '退款数量',
    refund_amount DECIMAL(10,2) DEFAULT 0 COMMENT '退款金额',
    refund_status VARCHAR(20) DEFAULT 'NONE' COMMENT '退款状态：NONE-未退款，PARTIAL-部分退款，FULL-全额退款',

    -- 发货信息
    shipped_quantity INT DEFAULT 0 COMMENT '已发货数量',
    shipped_time DATETIME COMMENT '发货时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_order_id (order_id),
    INDEX idx_sku_id (sku_id),
    INDEX idx_product_id (product_id),
    INDEX idx_refund_status (refund_status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单商品关联表';
```

#### 业务节点说明

**创建节点**：
- 订单创建时同步创建商品明细记录
- 用户修改订单商品时更新明细
- 订单拆分时创建新的商品明细

**变更节点**：
- 商品退款时更新退款相关字段
- 商品发货时更新发货信息
- 商品数量变更时更新数量和价格
- 优惠信息变更时更新优惠金额

**删除节点**：
- 订单删除时同步删除商品明细
- 商品从订单中移除时删除明细记录

---

### 6. 领取商品关联表 (t_order_pickup_item_rel)

#### 表结构
```sql
CREATE TABLE t_order_pickup_item_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    pickup_record_id BIGINT NOT NULL COMMENT '领取记录ID',
    order_item_id BIGINT NOT NULL COMMENT '订单商品ID',
    sku_id BIGINT NOT NULL COMMENT 'SKU ID',
    pickup_quantity INT NOT NULL COMMENT '领取数量',
    pickup_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
    pickup_user_id BIGINT COMMENT '领取人ID',
    pickup_user_name VARCHAR(100) COMMENT '领取人姓名',
    pickup_remark VARCHAR(200) COMMENT '领取备注',

    -- 门店领取信息
    store_id BIGINT COMMENT '门店ID',
    staff_id BIGINT COMMENT '服务人员ID',
    staff_name VARCHAR(50) COMMENT '服务人员姓名',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_pickup_record_id (pickup_record_id),
    INDEX idx_order_item_id (order_item_id),
    INDEX idx_sku_id (sku_id),
    INDEX idx_pickup_time (pickup_time),
    INDEX idx_store_id (store_id),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='领取商品关联表';
```

#### 业务节点说明

**创建节点**：
- 用户领取商品时创建领取明细记录
- 门店工作人员确认领取时创建记录
- 系统自动确认领取时创建记录

**变更节点**：
- 领取信息修改时更新相关字段
- 补充领取备注时更新备注信息

**删除节点**：
- 领取记录删除时同步删除明细
- 订单取消时清理相关领取明细

---

### 7. 订单状态变更日志表 (t_order_status_change_log)

#### 表结构
```sql
CREATE TABLE t_order_status_change_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    old_status VARCHAR(20) COMMENT '变更前状态',
    new_status VARCHAR(20) NOT NULL COMMENT '变更后状态',
    change_reason VARCHAR(200) COMMENT '变更原因',
    change_type VARCHAR(20) COMMENT '变更类型：USER-用户操作，SYSTEM-系统操作，ADMIN-管理员操作',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    operator_ip VARCHAR(50) COMMENT '操作人IP',
    change_remark VARCHAR(500) COMMENT '变更备注',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_order_id (order_id),
    INDEX idx_new_status (new_status),
    INDEX idx_change_type (change_type),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_order_time (order_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单状态变更日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 订单状态发生变更时记录日志
- 用户操作导致状态变更时记录
- 系统自动状态变更时记录
- 管理员手动变更状态时记录

**变更节点**：
- 通常状态变更日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留2年）
- 系统存储空间不足时清理最旧的日志

---

### 8. 订单支付日志表 (t_order_payment_log)

#### 表结构
```sql
CREATE TABLE t_order_payment_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    payment_id BIGINT COMMENT '支付记录ID',
    log_type VARCHAR(20) NOT NULL COMMENT '日志类型：PAYMENT-支付，REFUND-退款，QUERY-查询',
    operation_type VARCHAR(20) COMMENT '操作类型：REQUEST-请求，RESPONSE-响应，NOTIFY-通知',
    payment_method VARCHAR(20) COMMENT '支付方式',
    payment_amount DECIMAL(10,2) COMMENT '支付金额',
    transaction_id VARCHAR(100) COMMENT '第三方交易号',
    request_params TEXT COMMENT '请求参数',
    response_params TEXT COMMENT '响应参数',
    request_time DATETIME COMMENT '请求时间',
    response_time DATETIME COMMENT '响应时间',
    is_success TINYINT(1) COMMENT '是否成功',
    error_code VARCHAR(50) COMMENT '错误代码',
    error_message VARCHAR(200) COMMENT '错误信息',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_order_id (order_id),
    INDEX idx_payment_id (payment_id),
    INDEX idx_log_type (log_type),
    INDEX idx_operation_type (operation_type),
    INDEX idx_is_success (is_success),
    INDEX idx_created_time (created_time),
    INDEX idx_order_time (order_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单支付日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户发起支付请求时记录日志
- 第三方支付回调时记录日志
- 支付查询操作时记录日志
- 退款操作时记录日志

**变更节点**：
- 通常支付日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 系统存储空间不足时清理最旧的日志

---

### 9. 订单退款日志表 (t_order_refund_log)

#### 表结构
```sql
CREATE TABLE t_order_refund_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    refund_id BIGINT COMMENT '退款申请ID',
    log_type VARCHAR(20) NOT NULL COMMENT '日志类型：APPLY-申请，APPROVE-审核，PROCESS-处理，COMPLETE-完成',
    refund_amount DECIMAL(10,2) COMMENT '退款金额',
    transaction_id VARCHAR(100) COMMENT '退款交易号',
    request_params TEXT COMMENT '请求参数',
    response_params TEXT COMMENT '响应参数',
    request_time DATETIME COMMENT '请求时间',
    response_time DATETIME COMMENT '响应时间',
    is_success TINYINT(1) COMMENT '是否成功',
    error_code VARCHAR(50) COMMENT '错误代码',
    error_message VARCHAR(200) COMMENT '错误信息',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    operation_remark VARCHAR(500) COMMENT '操作备注',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_order_id (order_id),
    INDEX idx_refund_id (refund_id),
    INDEX idx_log_type (log_type),
    INDEX idx_operator_id (operator_id),
    INDEX idx_is_success (is_success),
    INDEX idx_created_time (created_time),
    INDEX idx_order_time (order_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单退款日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户申请退款时记录申请日志
- 管理员审核退款时记录审核日志
- 退款处理时记录处理日志
- 退款完成时记录完成日志

**变更节点**：
- 通常退款日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 系统存储空间不足时清理最旧的日志

---

### 10. 订单领取日志表 (t_order_pickup_log)

#### 表结构
```sql
CREATE TABLE t_order_pickup_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    pickup_record_id BIGINT COMMENT '领取记录ID',
    log_type VARCHAR(20) NOT NULL COMMENT '日志类型：CREATE-创建，UPDATE-更新，COMPLETE-完成，CANCEL-取消',
    pickup_type VARCHAR(20) COMMENT '领取类型',
    pickup_quantity INT COMMENT '领取数量',
    pickup_user_id BIGINT COMMENT '领取人ID',
    pickup_user_name VARCHAR(100) COMMENT '领取人姓名',
    pickup_location VARCHAR(200) COMMENT '领取地点',
    operation_remark VARCHAR(500) COMMENT '操作备注',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    ip_address VARCHAR(50) COMMENT 'IP地址',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_order_id (order_id),
    INDEX idx_pickup_record_id (pickup_record_id),
    INDEX idx_log_type (log_type),
    INDEX idx_pickup_user_id (pickup_user_id),
    INDEX idx_operator_id (operator_id),
    INDEX idx_created_time (created_time),
    INDEX idx_order_time (order_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单领取日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 创建领取记录时记录创建日志
- 更新领取信息时记录更新日志
- 完成领取时记录完成日志
- 取消领取时记录取消日志

**变更节点**：
- 通常领取日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 系统存储空间不足时清理最旧的日志

---

## 数据管理策略

### 数据清理策略
1. **订单基础数据**：永久保留，除非用户主动删除
2. **支付记录数据**：永久保留，用于财务对账
3. **退款申请数据**：永久保留，用于退款记录
4. **领取记录数据**：永久保留，用于消费记录
5. **订单商品明细**：随订单生命周期清理
6. **领取商品明细**：随领取记录生命周期清理
7. **状态变更日志**：保留2年，超过2年的数据归档
8. **支付日志**：保留1年，超过1年的数据清理
9. **退款日志**：保留1年，超过1年的数据清理
10. **领取日志**：保留1年，超过1年的数据清理

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：订单信息和状态使用Redis缓存

### 安全策略
1. **订单操作审计**：所有订单状态变更必须记录操作日志
2. **支付安全**：支付相关信息需要加密存储
3. **权限控制**：订单管理和退款需要严格的权限验证
4. **数据一致性**：通过事务保证订单数据的一致性
