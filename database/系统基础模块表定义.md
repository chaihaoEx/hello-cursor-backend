# 系统基础模块表定义

## 概述
系统基础模块包含系统配置管理、文件存储、脚本管理以及系统日志记录等核心功能。

## 表结构定义

### 1. 系统配置表 (t_system_config)

#### 表结构
```sql
CREATE TABLE t_system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    config_key VARCHAR(100) NOT NULL COMMENT '配置键',
    config_value TEXT COMMENT '配置值',
    config_type VARCHAR(50) COMMENT '配置类型：SYSTEM-系统配置，BUSINESS-业务配置',
    description VARCHAR(500) COMMENT '配置描述',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_config_key (config_key),
    INDEX idx_config_type (config_type),
    INDEX idx_created_time (created_time),
    INDEX idx_updated_time (updated_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统配置表';
```

#### 业务节点说明

**创建节点**：
- 系统初始化时创建基础配置项
- 管理员在管理后台添加新的配置项
- 业务模块需要时动态创建配置项
- 系统升级时添加新的配置项

**变更节点**：
- 管理员在管理后台修改配置值
- 系统自动更新配置（如定时任务配置）
- 业务参数调整时更新配置
- 配置值需要加密存储时更新

**删除节点**：
- 不再使用的配置项进行逻辑删除（is_deleted=1）
- 系统升级时废弃的配置项
- 业务模块下线时清理相关配置

---

### 2. 文件表 (t_system_file)

#### 表结构
```sql
CREATE TABLE t_system_file (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    file_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    file_path VARCHAR(500) NOT NULL COMMENT '文件存储路径',
    file_url VARCHAR(500) COMMENT '文件访问URL',
    file_size BIGINT NOT NULL COMMENT '文件大小（字节）',
    file_type VARCHAR(50) COMMENT '文件类型：IMAGE-图片，VIDEO-视频，DOCUMENT-文档，OTHER-其他',
    mime_type VARCHAR(100) COMMENT 'MIME类型',
    file_md5 VARCHAR(32) COMMENT '文件MD5值，用于去重',
    storage_type VARCHAR(20) NOT NULL DEFAULT 'OSS' COMMENT '存储类型：OSS-阿里云OSS，LOCAL-本地存储',
    bucket_name VARCHAR(100) COMMENT '存储桶名称',
    upload_source VARCHAR(50) COMMENT '上传来源：ADMIN-管理员上传，USER-用户上传，SYSTEM-系统生成',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_file_md5 (file_md5),
    INDEX idx_upload_source (upload_source),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件表';
```

#### 业务节点说明

**创建节点**：
- 用户上传头像时创建文件记录
- 管理员上传商品图片时创建文件记录
- 系统生成报表文件时创建文件记录
- 用户发布文章上传图片时创建文件记录

**变更节点**：
- 文件信息需要更新时（如URL变更）
- 文件关联的业务信息变更时更新

**删除节点**：
- 用户删除头像时逻辑删除文件记录
- 管理员删除商品图片时逻辑删除
- 文章删除时同步删除相关图片
- 定期清理未关联的过期文件

---

### 3. 脚本表 (t_system_script)

#### 表结构
```sql
CREATE TABLE t_system_script (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    script_name VARCHAR(100) NOT NULL COMMENT '脚本名称',
    script_code TEXT NOT NULL COMMENT 'Java脚本代码',
    script_type VARCHAR(20) NOT NULL DEFAULT 'JAVA' COMMENT '脚本类型：JAVA-Java脚本',
    script_version VARCHAR(20) COMMENT '脚本版本号',
    description VARCHAR(500) COMMENT '脚本描述',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_script_name (script_name),
    INDEX idx_script_type (script_type),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Java脚本表';
```

#### 业务节点说明

**创建节点**：
- 管理员在管理后台创建新的脚本
- 系统初始化时创建基础脚本
- 业务需求需要时创建自定义脚本
- 版本升级时添加新的脚本

**变更节点**：
- 脚本代码更新时修改script_code
- 脚本参数调整时更新parameters
- 脚本版本升级时更新script_version
- 脚本激活状态变更时更新is_active
- 脚本执行统计更新时修改execution_count

**删除节点**：
- 脚本不再使用时进行逻辑删除
- 脚本版本升级后废弃旧版本
- 业务模块下线时清理相关脚本

---

### 4. 系统操作日志表 (t_system_operation_log)

#### 表结构
```sql
CREATE TABLE t_system_operation_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    operation_type VARCHAR(50) NOT NULL COMMENT '操作类型：CREATE-创建，UPDATE-更新，DELETE-删除，LOGIN-登录',
    operation_module VARCHAR(50) NOT NULL COMMENT '操作模块：USER-用户，PRODUCT-商品，ORDER-订单',
    operation_action VARCHAR(100) NOT NULL COMMENT '具体操作：USER_LOGIN-用户登录，PRODUCT_CREATE-商品创建',
    operation_desc VARCHAR(500) COMMENT '操作描述',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(100) COMMENT '操作人姓名',
    operator_ip VARCHAR(50) COMMENT '操作人IP地址',
    user_agent TEXT COMMENT '用户代理信息',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_method VARCHAR(10) COMMENT '请求方法：GET、POST、PUT、DELETE',
    request_params TEXT COMMENT '请求参数（JSON格式）',
    response_code VARCHAR(10) COMMENT '响应状态码',
    response_msg VARCHAR(500) COMMENT '响应消息',
    execution_time BIGINT COMMENT '执行耗时（毫秒）',
    is_success TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否成功：0-失败，1-成功',
    error_message TEXT COMMENT '错误信息',

    -- 时间字段（日志表通常不更新，以保证不可篡改性）
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间（通常不更新）',

    -- 索引
    INDEX idx_operation_type (operation_type),
    INDEX idx_operation_module (operation_module),
    INDEX idx_operator_id (operator_id),
    INDEX idx_is_success (is_success),
    INDEX idx_created_time (created_time),
    INDEX idx_created_time_operator (created_time, operator_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统操作日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户登录系统时记录登录日志
- 管理员执行管理操作时记录操作日志
- 系统自动执行定时任务时记录日志
- API接口被调用时记录访问日志
- 系统发生异常时记录错误日志

**变更节点**：
- 通常操作日志不进行变更，以保证日志的不可篡改性
- 特殊情况下可能需要补充日志信息（如异步处理结果）

**删除节点**：
- 按时间定期清理过期日志（通常保留6个月-2年）
- 系统存储空间不足时清理最旧的日志
- 合规要求下删除敏感信息日志

---

### 5. 系统错误日志表 (t_system_error_log)

#### 表结构
```sql
CREATE TABLE t_system_error_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    error_level VARCHAR(20) NOT NULL COMMENT '错误级别：FATAL-致命，ERROR-错误，WARN-警告，INFO-信息',
    error_code VARCHAR(50) COMMENT '错误代码',
    error_message TEXT NOT NULL COMMENT '错误消息',
    error_stack TEXT COMMENT '错误堆栈信息',
    error_class VARCHAR(200) COMMENT '异常类名',
    error_method VARCHAR(100) COMMENT '发生错误的方法名',
    error_file VARCHAR(200) COMMENT '错误文件路径',
    error_line INT COMMENT '错误行号',
    request_id VARCHAR(50) COMMENT '请求ID，用于链路追踪',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_method VARCHAR(10) COMMENT '请求方法',
    request_params TEXT COMMENT '请求参数',
    user_id BIGINT COMMENT '用户ID',
    user_ip VARCHAR(50) COMMENT '用户IP',
    user_agent TEXT COMMENT '用户代理信息',
    server_ip VARCHAR(50) COMMENT '服务器IP',
    server_name VARCHAR(100) COMMENT '服务器名称',
    environment VARCHAR(20) COMMENT '环境：DEV-开发，TEST-测试，PROD-生产',
    is_handled TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否已处理：0-未处理，1-已处理',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    INDEX idx_error_level (error_level),
    INDEX idx_error_code (error_code),
    INDEX idx_request_id (request_id),
    INDEX idx_user_id (user_id),
    INDEX idx_is_handled (is_handled),
    INDEX idx_created_time (created_time),
    INDEX idx_created_time_level (created_time, error_level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统错误日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 系统发生未捕获异常时记录错误日志
- 业务逻辑执行失败时记录错误日志
- 第三方接口调用失败时记录错误日志
- 系统性能问题时记录警告日志
- 数据库连接异常时记录错误日志

**变更节点**：
- 错误被处理后更新is_handled状态
- 补充错误上下文信息时更新相关字段
- 错误等级调整时更新error_level

**删除节点**：
- 按时间定期清理过期错误日志（通常保留3-6个月）
- 错误已解决且无需保留时清理
- 系统存储优化时清理低级别错误日志

---

## 数据管理策略

### 数据清理策略
1. **操作日志**：保留2年，超过2年的数据归档到历史库
2. **错误日志**：保留6个月，超过6个月的数据清理
3. **配置数据**：永久保留，除非业务明确废弃
4. **文件数据**：根据业务需要保留，定期清理未关联文件

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **压缩存储**：历史数据可以压缩存储
### 安全策略
1. **敏感信息脱敏**：日志中的敏感信息需要脱敏处理
2. **访问控制**：系统日志需要严格的访问权限控制
3. **审计追踪**：重要操作必须记录操作日志
4. **异常监控**：错误日志需要实时监控和告警
