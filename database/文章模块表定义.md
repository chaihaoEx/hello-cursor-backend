# 文章模块表定义

## 概述
文章模块包含文章内容管理、分类体系、标签系统以及用户互动功能。所有文章都以Markdown格式存储，通过分类KEY值进行灵活的页面展示控制。

## 表结构定义

### 1. 文章分类表 (t_article_category)

#### 表结构
```sql
CREATE TABLE t_article_category (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    category_name VARCHAR(100) NOT NULL COMMENT '分类名称',
    category_code VARCHAR(50) NOT NULL COMMENT '分类编码',
    description VARCHAR(500) COMMENT '分类描述',
    sort_order INT DEFAULT 0 COMMENT '排序序号',

    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-禁用',
    article_count BIGINT DEFAULT 0 COMMENT '分类下文章数量',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_category_code (category_code),
    INDEX idx_status (status),
    INDEX idx_sort_order (sort_order),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章分类表';
```

#### 业务节点说明

**创建节点**：
- 管理员在后台创建新的文章分类
- 系统初始化时创建基础分类
- 运营人员根据内容规划创建分类

**变更节点**：
- 管理员修改分类名称、描述等信息
- 调整显示顺序时更新sort_order
- 分类下文章数量变化时更新article_count

**删除节点**：
- 分类不再使用时逻辑删除
- 合并分类时清理旧分类
- 系统重构时清理无效分类

---

### 2. 文章标签表 (t_article_tag)

#### 表结构
```sql
CREATE TABLE t_article_tag (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    tag_name VARCHAR(50) NOT NULL COMMENT '标签名称',
    tag_color VARCHAR(20) COMMENT '标签颜色',
    description VARCHAR(200) COMMENT '标签描述',

    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-正常，0-禁用',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_tag_name (tag_name),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章标签表';
```

#### 业务节点说明

**创建节点**：
- 管理员创建新的标签
- 文章发布时自动创建新标签

**变更节点**：
- 修改标签名称、颜色、描述
- 标签状态变更

**删除节点**：
- 标签不再使用时逻辑删除
- 合并标签时清理重复标签

---

### 3. 文章表 (t_article_article)

#### 表结构
```sql
CREATE TABLE t_article_article (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    title VARCHAR(200) NOT NULL COMMENT '文章标题',
    summary VARCHAR(500) COMMENT '文章摘要',
    content_markdown TEXT NOT NULL COMMENT 'Markdown内容',
    content_html TEXT COMMENT 'HTML内容（渲染后的）',
    cover_image VARCHAR(500) COMMENT '封面图片URL',
    author_id BIGINT COMMENT '作者ID',
    author_name VARCHAR(100) COMMENT '作者姓名',
    category_id BIGINT COMMENT '分类ID',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-发布，2-草稿，3-审核中，4-已删除',
    is_top TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否置顶：0-否，1-是',
    is_recommend TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否推荐：0-否，1-是',
    view_count BIGINT DEFAULT 0 COMMENT '浏览次数',
    like_count BIGINT DEFAULT 0 COMMENT '点赞次数',
    share_count BIGINT DEFAULT 0 COMMENT '分享次数',
    word_count INT DEFAULT 0 COMMENT '字数统计',
    read_time INT DEFAULT 0 COMMENT '预计阅读时间（分钟）',
    publish_time DATETIME COMMENT '发布时间',
    last_edit_time DATETIME COMMENT '最后编辑时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    INDEX idx_author_id (author_id),
    INDEX idx_category_id (category_id),
    INDEX idx_status (status),
    INDEX idx_is_top (is_top),
    INDEX idx_is_recommend (is_recommend),
    INDEX idx_publish_time (publish_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted),
    INDEX idx_category_status (category_id, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章表';
```

#### 业务节点说明

**创建节点**：
- 作者在后台创建新文章
- 批量导入文章内容

**变更节点**：
- 作者修改文章内容时更新content_markdown和content_html
- 文章状态变化时更新status
- 发布文章时设置publish_time
- 文章统计数据变化时更新view_count、like_count等

**删除节点**：
- 作者删除文章时逻辑删除
- 系统清理过期草稿
- 违规文章被管理员删除

---

### 4. 文章标签关联表 (t_article_article_tag_rel)

#### 表结构
```sql
CREATE TABLE t_article_article_tag_rel (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    article_id BIGINT NOT NULL COMMENT '文章ID',
    tag_id BIGINT NOT NULL COMMENT '标签ID',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_article_tag (article_id, tag_id),
    INDEX idx_article_id (article_id),
    INDEX idx_tag_id (tag_id),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章标签关联表';
```

#### 业务节点说明

**创建节点**：
- 文章发布时建立标签关联
- 作者为文章添加标签时创建关联
- 系统自动为文章打标签时创建关联

**变更节点**：
- 通常不进行变更，以保证关联关系的稳定

**删除节点**：
- 文章删除时清理标签关联
- 移除文章标签时删除关联
- 标签删除时清理相关关联

---

### 5. 文章统计缓存表 (t_article_article_stats_cache)

#### 表结构
```sql
CREATE TABLE t_article_article_stats_cache (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    article_id BIGINT NOT NULL COMMENT '文章ID',
    view_count BIGINT DEFAULT 0 COMMENT '浏览次数',
    like_count BIGINT DEFAULT 0 COMMENT '点赞次数',
    share_count BIGINT DEFAULT 0 COMMENT '分享次数',
    collect_count BIGINT DEFAULT 0 COMMENT '收藏次数',
    last_update_time DATETIME NOT NULL COMMENT '最后更新时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_article_id (article_id),
    INDEX idx_view_count (view_count),
    INDEX idx_like_count (like_count),
    INDEX idx_last_update_time (last_update_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章统计缓存表';
```

#### 业务节点说明

**创建节点**：
- 文章发布时创建统计缓存记录
- 系统定期生成统计数据时创建

**变更节点**：
- 用户浏览文章时更新view_count
- 用户点赞时更新like_count
- 用户分享时更新share_count
- 用户收藏时更新collect_count

**删除节点**：
- 文章删除时清理统计缓存
- 系统定期清理无效统计数据

---

### 6. 文章点赞日志表 (t_article_like_log)

#### 表结构
```sql
CREATE TABLE t_article_like_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    article_id BIGINT NOT NULL COMMENT '文章ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    like_type TINYINT(1) NOT NULL DEFAULT 1 COMMENT '点赞类型：1-点赞，2-踩',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',

    -- 时间字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    UNIQUE KEY uk_article_user (article_id, user_id),
    INDEX idx_article_id (article_id),
    INDEX idx_user_id (user_id),
    INDEX idx_like_type (like_type),
    INDEX idx_created_time (created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章点赞日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户点击点赞按钮时记录日志
- 用户取消点赞时记录日志
- 系统检测到重复点赞时记录

**变更节点**：
- 通常点赞日志不进行变更，以保证日志的不可篡改性

**删除节点**：
- 按时间定期清理过期点赞日志（通常保留6个月）
- 文章删除时清理相关点赞记录
- 用户注销时清理相关记录

---





## 文章查询逻辑

### 分类查询机制
文章查询通过分类的KEY值（category_code）进行控制，不再区分系统文章和普通文章。

### 查询逻辑

#### 按分类查询文章
文章查询需要同时满足以下条件：文章状态为发布状态、指定分类KEY值、文章和分类都未被删除。按照置顶优先和发布时间倒序排列。

#### 多分类查询
支持通过多个分类KEY值查询文章，可以同时查询多个分类下的文章内容。

#### 管理员查询
管理员可以查看所有分类的文章，通过指定分类KEY值或查询所有文章。

### 业务规则

#### 分类控制特点
1. **通过KEY值控制**：页面展示通过分类的KEY值进行精确控制
2. **灵活的分类管理**：可以根据业务需求动态调整分类KEY值
3. **统一查询接口**：所有文章查询都通过分类KEY值进行过滤

#### 展示策略
前端通过传递分类KEY值来控制文章的展示范围，支持单个分类或多个分类的查询。

#### 查询优化逻辑
通过分类KEY值进行索引查询，提升查询性能，支持快速定位指定分类的文章内容。

---

## 数据管理策略

### 数据清理策略
1. **点赞日志**：保留6个月，超过6个月的数据清理
2. **文章数据**：永久保留，除非作者主动删除
3. **统计缓存**：随文章生命周期清理

### 性能优化策略
1. **分区表**：日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **缓存策略**：文章内容和统计数据使用Redis缓存
4. **读写分离**：日志表主要写入，查询相对较少

### 安全策略
1. **权限控制**：通过分类KEY值控制文章访问权限
2. **防刷机制**：点赞需要防刷机制
3. **数据脱敏**：日志中的敏感信息需要脱敏处理
