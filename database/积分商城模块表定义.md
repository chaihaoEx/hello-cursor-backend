# 积分商城模块表定义

## 概述
积分商城模块包含积分商品信息管理、兑换限制规则配置以及用户积分兑换记录。支持实体商品和虚拟商品的积分兑换，通过限制规则控制兑换频次和条件。

## 表结构定义

### 1. 商城商品表 (t_mall_mall_product)

#### 表结构
```sql
CREATE TABLE t_mall_mall_product (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    product_name VARCHAR(200) NOT NULL COMMENT '商品名称',
    product_code VARCHAR(50) UNIQUE NOT NULL COMMENT '商品编码',
    product_type VARCHAR(20) NOT NULL COMMENT '商品类型：PHYSICAL-实体商品，VIRTUAL-虚拟商品，COUPON-优惠券',
    category_id BIGINT COMMENT '商品分类ID',
    exchange_points BIGINT NOT NULL COMMENT '兑换所需积分',
    original_price DECIMAL(10,2) COMMENT '商品原价',
    stock_quantity INT NOT NULL DEFAULT 0 COMMENT '库存数量',
    sales_count INT DEFAULT 0 COMMENT '销售数量',
    exchange_limit INT COMMENT '每人兑换限制次数',
    daily_limit INT COMMENT '每日兑换限制',
    weekly_limit INT COMMENT '每周兑换限制',
    monthly_limit INT COMMENT '每月兑换限制',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '商品状态：1-上架，2-下架，3-售罄，4-删除',
    is_hot TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否热门：0-否，1-是',
    is_recommend TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否推荐：0-否，1-是',
    sort_order INT DEFAULT 0 COMMENT '排序序号',

    -- 商品信息
    main_image VARCHAR(500) COMMENT '主图URL',
    image_urls TEXT COMMENT '商品图片URL集合（JSON格式）',
    description TEXT COMMENT '商品描述',
    exchange_instructions TEXT COMMENT '兑换说明',
    virtual_content TEXT COMMENT '虚拟商品内容',

    -- 优惠券信息（当product_type为COUPON时使用）
    coupon_type VARCHAR(20) COMMENT '优惠券类型：DISCOUNT-折扣券，CASH-现金券，EXCHANGE-兑换券',
    coupon_value DECIMAL(10,2) COMMENT '优惠券面值',
    coupon_condition DECIMAL(10,2) COMMENT '使用条件',
    expiry_days INT COMMENT '优惠券有效期（天）',

    -- 时间限制
    start_time DATETIME COMMENT '兑换开始时间',
    end_time DATETIME COMMENT '兑换结束时间',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_product_code (product_code),
    INDEX idx_category_id (category_id),
    INDEX idx_product_type (product_type),
    INDEX idx_status (status),
    INDEX idx_exchange_points (exchange_points),
    INDEX idx_is_hot (is_hot),
    INDEX idx_is_recommend (is_recommend),
    INDEX idx_sort_order (sort_order),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商城商品表';
```

#### 业务节点说明

**创建节点**：
- 管理员在后台创建新的积分商品
- 系统批量导入积分商品数据
- 运营活动需要时创建限时商品

**变更节点**：
- 商品信息更新时修改商品基本信息
- 积分价格调整时更新exchange_points
- 商品状态变更时更新status
- 库存变化时更新stock_quantity
- 兑换限制调整时更新限制字段

**删除节点**：
- 商品下架且不再兑换时逻辑删除
- 商品信息错误需要清理时删除
- 活动结束且商品过期时删除

---

### 2. 兑换限制表 (t_mall_exchange_limit)

#### 表结构
```sql
CREATE TABLE t_mall_exchange_limit (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    limit_name VARCHAR(100) NOT NULL COMMENT '限制规则名称',
    limit_code VARCHAR(50) UNIQUE NOT NULL COMMENT '限制规则编码',
    limit_type VARCHAR(20) NOT NULL COMMENT '限制类型：USER-用户限制，PRODUCT-商品限制，GLOBAL-全局限制',
    target_id BIGINT COMMENT '目标ID（用户ID或商品ID）',
    exchange_limit INT NOT NULL COMMENT '兑换限制次数',
    time_range VARCHAR(20) NOT NULL COMMENT '时间范围：DAY-每日，WEEK-每周，MONTH-每月，TOTAL-总计',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1-启用，0-禁用',
    start_time DATETIME COMMENT '限制开始时间',
    end_time DATETIME COMMENT '限制结束时间',
    limit_description VARCHAR(500) COMMENT '限制描述',
    auto_reset TINYINT(1) NOT NULL DEFAULT 1 COMMENT '是否自动重置：0-否，1-是',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    created_by VARCHAR(100) COMMENT '创建人',
    updated_by VARCHAR(100) COMMENT '更新人',
    is_deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除：0-未删除，1-已删除',
    version INT NOT NULL DEFAULT 1 COMMENT '版本号，用于乐观锁',

    -- 索引
    UNIQUE KEY uk_limit_code (limit_code),
    INDEX idx_limit_type (limit_type),
    INDEX idx_target_id (target_id),
    INDEX idx_time_range (time_range),
    INDEX idx_status (status),
    INDEX idx_start_time (start_time),
    INDEX idx_end_time (end_time),
    INDEX idx_created_time (created_time),
    INDEX idx_is_deleted (is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='兑换限制表';
```

#### 业务节点说明

**创建节点**：
- 管理员创建兑换限制规则
- 系统根据业务需求自动创建限制
- 商品上架时同步创建兑换限制

**变更节点**：
- 限制次数调整时更新exchange_limit
- 时间范围变更时更新time_range
- 限制状态变更时更新status
- 生效时间调整时更新时间字段

**删除节点**：
- 限制规则不再使用时逻辑删除
- 商品下架时清理相关限制规则
- 活动结束时清理临时限制

---

### 3. 积分兑换日志表 (t_mall_exchange_log)

#### 表结构
```sql
CREATE TABLE t_mall_exchange_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    exchange_no VARCHAR(50) UNIQUE NOT NULL COMMENT '兑换单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    exchange_points BIGINT NOT NULL COMMENT '兑换积分',
    product_name VARCHAR(200) NOT NULL COMMENT '商品名称',
    product_type VARCHAR(20) NOT NULL COMMENT '商品类型',
    quantity INT NOT NULL DEFAULT 1 COMMENT '兑换数量',
    total_points BIGINT NOT NULL COMMENT '总消耗积分',
    exchange_status VARCHAR(20) NOT NULL DEFAULT 'SUCCESS' COMMENT '兑换状态：SUCCESS-成功，FAILED-失败，CANCELLED-取消',
    exchange_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '兑换时间',
    failure_reason VARCHAR(200) COMMENT '失败原因',
    delivery_status VARCHAR(20) COMMENT '发货状态：PENDING-待发货，SHIPPED-已发货，DELIVERED-已送达，RECEIVED-已签收',
    delivery_info TEXT COMMENT '发货信息（JSON格式）',
    virtual_content TEXT COMMENT '虚拟商品内容',
    coupon_code VARCHAR(50) COMMENT '优惠券码',
    coupon_status VARCHAR(20) COMMENT '优惠券状态：UNUSED-未使用，USED-已使用，EXPIRED-已过期',
    coupon_used_time DATETIME COMMENT '优惠券使用时间',
    ip_address VARCHAR(50) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理信息',

    -- 审计字段
    created_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 索引
    UNIQUE KEY uk_exchange_no (exchange_no),
    INDEX idx_user_id (user_id),
    INDEX idx_product_id (product_id),
    INDEX idx_exchange_status (exchange_status),
    INDEX idx_delivery_status (delivery_status),
    INDEX idx_coupon_status (coupon_status),
    INDEX idx_exchange_time (exchange_time),
    INDEX idx_created_time (created_time),
    INDEX idx_user_time (user_id, created_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分兑换日志表'

-- 分区策略（按月分区）
PARTITION BY RANGE (YEAR(created_time)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

#### 业务节点说明

**创建节点**：
- 用户成功兑换商品时记录兑换日志
- 用户兑换失败时记录失败日志
- 系统自动兑换时记录日志

**变更节点**：
- 发货状态更新时修改delivery_status
- 优惠券使用时更新coupon_status
- 补充发货信息时更新delivery_info

**删除节点**：
- 按时间定期清理过期日志（通常保留1年）
- 用户注销账户时清理相关日志
- 系统存储空间不足时清理最旧的日志

---

## 数据管理策略

### 数据清理策略
1. **商城商品数据**：永久保留，除非商品明确下架
2. **兑换限制数据**：随商品或规则过期时清理
3. **兑换日志**：保留1年，超过1年的数据清理

### 性能优化策略
1. **分区表**：兑换日志表按月分区，提升查询性能
2. **索引优化**：建立复合索引满足常见查询需求
3. **读写分离**：日志表主要写入，查询相对较少
4. **缓存策略**：商品信息和库存使用Redis缓存

### 安全策略
1. **兑换操作审计**：所有积分兑换必须记录详细日志
2. **防刷机制**：积分兑换需要防刷机制
3. **权限控制**：商品管理和兑换操作需要严格的权限验证
4. **数据一致性**：通过事务保证积分和库存数据的一致性
